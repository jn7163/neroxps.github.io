<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.proxy.ustclug.org/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="黑苹果,Mac,Hackintosh,ASUS,VM510LI," />





  <link rel="alternate" href="/atom.xml" title="Nero Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="本笔记参考 RehabMan 指南 [Guide] Using Clover to “hotpatch” ACPI   [TOC] Hotpatch 简述什么是 Hotpatch?  RehabMan 的介绍是:  That guide uses what is known as “static patching”. In order to inject patched ACPI files,">
<meta name="keywords" content="黑苹果,Mac,Hackintosh,ASUS,VM510LI">
<meta property="og:type" content="article">
<meta property="og:title" content="华硕 VM510LI Hotpatch">
<meta property="og:url" content="http://hexo.neroxps.cn/2017/02/25/Hotpatch/index.html">
<meta property="og:site_name" content="Nero Blog">
<meta property="og:description" content="本笔记参考 RehabMan 指南 [Guide] Using Clover to “hotpatch” ACPI   [TOC] Hotpatch 简述什么是 Hotpatch?  RehabMan 的介绍是:  That guide uses what is known as “static patching”. In order to inject patched ACPI files,">
<meta property="og:updated_time" content="2017-07-19T12:47:36.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="华硕 VM510LI Hotpatch">
<meta name="twitter:description" content="本笔记参考 RehabMan 指南 [Guide] Using Clover to “hotpatch” ACPI   [TOC] Hotpatch 简述什么是 Hotpatch?  RehabMan 的介绍是:  That guide uses what is known as “static patching”. In order to inject patched ACPI files,">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://hexo.neroxps.cn/2017/02/25/Hotpatch/"/>





  <title>华硕 VM510LI Hotpatch | Nero Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6990360e021ae3bf2debc80fd3be44dd";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Nero Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://hexo.neroxps.cn/2017/02/25/Hotpatch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Nero Hau">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nero Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">华硕 VM510LI Hotpatch</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-25T00:00:00+08:00">
                2017-02-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/黑苹果/" itemprop="url" rel="index">
                    <span itemprop="name">黑苹果</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/02/25/Hotpatch/" class="leancloud_visitors" data-flag-title="华硕 VM510LI Hotpatch">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>本笔记参考 RehabMan 指南 <a href="https://www.tonymacx86.com/threads/guide-using-clover-to-hotpatch-acpi.200137/" target="_blank" rel="external">[Guide] Using Clover to “hotpatch” ACPI</a> </p>
</blockquote>
<p>[TOC]</p>
<h2 id="Hotpatch-简述"><a href="#Hotpatch-简述" class="headerlink" title="Hotpatch 简述"></a>Hotpatch 简述</h2><p>什么是 Hotpatch? </p>
<p><strong>RehabMan 的介绍是:</strong></p>
<blockquote>
<p>That guide uses what is known as “static patching”. In order to inject patched ACPI files, we extract native ACPI, disassemble them, make changes, then recompile and place the files in ACPI/patched, so that Clover injects the patched ACPI instead of native ACPI. With the techniques detailed in this guide, the changes can be made directly to the ACPI binaries provided by BIOS, skipping the extract, disassembly, and recompilation steps.</p>
<p>该指南使用所谓的“静态修补”。 为了注入修补的ACPI文件，我们提取本地ACPI，反汇编，进行更改，然后重新编译并将文件放在ACPI / patched中，以便Clover注入修补的ACPI而不是本机ACPI。 使用本指南中详述的技术，可以直接对BIOS提供的ACPI二进制文件进行更改，跳过提取，反汇编和重新编译步骤。(翻译来自 Google 翻译)</p>
</blockquote>
<p><strong>我的理解:</strong></p>
<p>其实 Hotpatch 就是将所有修补 ACPI 文件的补丁变成一个一个模块,通过重命名主板提供的 ACPI 文件原来的 Method (方法/函数) 来禁用原有的方法,再用 SSDT 来放入我们修改后的(已修补)的 Method (方法/函数).</p>
<p>当然上面所说的是终极解决的办法,其实还有很多很简单的方法能够完成 ACPI 补丁的功能.</p>
<p>如果有兴趣可以去看看 RahabMan 帖子.</p>
<p>之前我在 DSDT 打的补丁有.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&quot;Fix _WAK Arg0 v2&quot; </div><div class="line">&quot;HPET Fix&quot; </div><div class="line">&quot;SMBUS Fix&quot;</div><div class="line">&quot;IRQ Fix&quot; </div><div class="line">&quot;RTC Fix&quot; </div><div class="line">&quot;OS Check Fix（Windows 7）&quot; </div><div class="line">&quot;OS Check Fix（Windows 8）&quot; </div><div class="line">&quot;Fix Mutex with non-zero SyncLevel&quot; //对比了下 这个补丁是不需要打的</div><div class="line">&quot;Rename GFX0 to IGPU&quot; </div><div class="line">&quot;Brightness fix(Haswell/Broadwell)&quot;</div></pre></td></tr></table></figure>
<h2 id="Clover-常规补丁"><a href="#Clover-常规补丁" class="headerlink" title="Clover 常规补丁"></a>Clover 常规补丁</h2><ul>
<li><code>Fix _WAK Arg0 v2</code>  →   <code>ACPI &gt; DSDT &gt; FIX_WAK_200000</code></li>
<li><code>IRQ Fix</code> 和 <code>HPET Fix</code> → <code>ACPI &gt; DSDT &gt; FixHPET_0010</code> 和 <code>ACPI &gt; DSDT &gt; FixIPIC_0040</code></li>
<li><code>RTC Fix</code> → <code>ACPI &gt; DSDT &gt; FIX_RTC_20000</code></li>
</ul>
<h2 id="OS-Check-Fix（Windows-7）和-OS-Check-Fix（Windows-8）"><a href="#OS-Check-Fix（Windows-7）和-OS-Check-Fix（Windows-8）" class="headerlink" title="OS Check Fix（Windows 7）和 OS Check Fix（Windows 8）"></a>OS Check Fix（Windows 7）和 OS Check Fix（Windows 8）</h2><p>HotPatch 的方式是,将调用 _OSI  的方法重命名为 XOSI. 然后再放入 SSDT-XOSI.aml 到 Clover &gt; ACPI &gt; Patched</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Comment: Change _OSI to XOSI</div><div class="line">Find: &lt;5f4f 5349&gt;</div><div class="line">Replace: &lt;584f 5349&gt;</div></pre></td></tr></table></figure>
<p>意思就是,将调用 _OSI 方法的地方都改成调用 XOSI,而 XOSI 方法则是从 SSDT-XOSI.aml 引入的,我们再从 XOSI 方法修补.</p>
<h2 id="Rename-GFX0-to-IGPU"><a href="#Rename-GFX0-to-IGPU" class="headerlink" title="Rename GFX0 to IGPU"></a>Rename GFX0 to IGPU</h2><p>和上面重命名方法一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Comment: Rename GFX0 to IGPU</div><div class="line">Find: &lt;4746 5830&gt;</div><div class="line">Replace: &lt;4947 5055&gt;</div></pre></td></tr></table></figure>
<h2 id="Brightness-fix-Haswell-Broadwell"><a href="#Brightness-fix-Haswell-Broadwell" class="headerlink" title="Brightness fix(Haswell/Broadwell)"></a>Brightness fix(Haswell/Broadwell)</h2><p>这个补丁方法</p>
<ol>
<li>GFX 重命名为 IGPU,上一节补丁已经应用了.</li>
<li>放入 SSDT-PNLF.aml</li>
<li>SSDT-Config.aml 需要定义 BKLT 的值为 0.</li>
</ol>
<h2 id="USB3-PRW-0X6D-instant-wake"><a href="#USB3-PRW-0X6D-instant-wake" class="headerlink" title="USB3_PRW 0X6D(instant wake)"></a>USB3_PRW 0X6D(instant wake)</h2><p>这个补丁方法,的方法遇上面的不太一样.</p>
<p><strong>补丁片段</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># some _PRW have three entries in the Package </div><div class="line">into device name_adr 0x001D0000 code_regex Name.*_PRW.*\n.*\n.*\n.*\n.*\n.*\&#125;\) remove_matched;</div><div class="line"></div><div class="line"># 找到设备名称地址 0x001D0000 然后移除该设备的 _PRW 方法.</div><div class="line"></div><div class="line"># seems to work better if _PRW is present, but returns 0 (original was 3) for sleep state</div><div class="line">into device name_adr 0x001D0000 insert begin Name(_PRW, Package() &#123; 0x6D, 0 &#125;) end;</div><div class="line"></div><div class="line"># 找到设备名称地址 0x001D0000  输入变量名 _PRW 变量内容 &#123; 0x6D, 0 &#125;</div><div class="line"></div><div class="line">PS: 以上纯属猜测,本人未学习过 IASL 的编程语法,全靠蒙,如果错了请指正.</div></pre></td></tr></table></figure>
<p> 这样修改后,USB 总线 EHC1和 EHC2 设备中没有了 _PRW 方法了,直接变成了 _PRW 变量. </p>
<p> 至于为何需要这样改,我并不清楚,这必须了解 USB 导致睡眠唤醒的代码原理,我看不懂.但是看补丁的修改方法还是会的.</p>
<p> 那么将上面的补丁换成 Hotpatch 应该如何表现呢?</p>
<p> 搜索了下, DSDT 中还有非常多的 _PRW 方法,他们遍布了整个 DSDT 的各种设备,如果还是使用简单的改名是不可靠的.</p>
<p> 因为 Clover 的 Patches 是搜索 DSDT 的二进制版本进行修补,二进制中无法识别整个_PRW 方法是否属于 USB 设备下的,也就是是否属于 EHC1 EHC2 的设备,那么是否就没办法用 Hotpatch 方法来修补这个问题呢?</p>
<p> 我们来看看被补丁修补的源代码是什么样的</p>
<p> 下面是 EHC1 的 _PRW 方法</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Method (_PRW, 0, NotSerialized)  // _PRW: Power Resources for Wake</div><div class="line">&#123;</div><div class="line">    Return (GPRW (0x6D, 0x03))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是 EHC2 的 _PRW 方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Method (_PRW, 0, NotSerialized)  // _PRW: Power Resources for Wake</div><div class="line">&#123;</div><div class="line">    Return (GPRW (0x6D, 0x03))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是 XHC 的 _PRW 方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Method (_PRW, 0, NotSerialized)  // _PRW: Power Resources for Wake</div><div class="line">&#123;</div><div class="line">    Return (GPRW (0x6D, 0x03))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以发现我们补丁修改的每个 _PRW 方法都会调用一个方法 GPRW,并且调用 GPRW 方法的变量内容都是 0X6D.</p>
<p>再看看 RehabMan 写的 SSDT-PRW.dsl 内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">// For solving instant wake by hooking GPRW or UPRW</div><div class="line"></div><div class="line">DefinitionBlock(&quot;&quot;, &quot;SSDT&quot;, 2, &quot;hack&quot;, &quot;PRW&quot;, 0)</div><div class="line">&#123;</div><div class="line">    External(XPRW, MethodObj)</div><div class="line"></div><div class="line">    // In DSDT, native GPRW is renamed to XPRW with Clover binpatch.</div><div class="line">    // (or UPRW to XPRW)</div><div class="line">    // As a result, calls to GPRW (or UPRW) land here.</div><div class="line">    // The purpose of this implementation is to avoid &quot;instant wake&quot;</div><div class="line">    // by returning 0 in the second position (sleep state supported)</div><div class="line">    // of the return package.</div><div class="line">    Method(GPRW, 2)</div><div class="line">    &#123;</div><div class="line">        If (0x6d == Arg0) &#123; Return (Package() &#123; 0x6d, 0, &#125;) &#125;   //检查第一个变量是否为 0X6D 如果结果为真,返回 &#123; 0x6d, 0, &#125;</div><div class="line">        If (0x0d == Arg0) &#123; Return (Package() &#123; 0x0d, 0, &#125;) &#125;   //检查第一个变量是否是 0X0D 如果结果为真,返回 &#123; 0x0d, 0, &#125;</div><div class="line">        Return (XPRW(Arg0, Arg1))                               //如果上述都不对,则转跳到 XPRW方法 (函数为转跳过来的值)</div><div class="line">    &#125;</div><div class="line">    Method(UPRW, 2)</div><div class="line">    &#123;</div><div class="line">        If (0x6d == Arg0) &#123; Return (Package() &#123; 0x6d, 0, &#125;) &#125;</div><div class="line">        If (0x0d == Arg0) &#123; Return (Package() &#123; 0x0d, 0, &#125;) &#125;</div><div class="line">        Return (XPRW(Arg0, Arg1))</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">//EOF</div></pre></td></tr></table></figure>
<p>上面的逻辑很清晰了, 其实就是要将我们需要改的地方,直接用代码发回我们希望他得到的变量,那么我们就不必想如何识别哪些是 USB 的 _PRW 方法了.</p>
<p>Hotpatch 我觉得就是,复杂的逻辑交给 ASL 代码来解决, Clover 的 Patch 只需要修改源代码的调用即可.</p>
<p>那么上面多了个 XPRW 是什么东东?为啥其余调用 GPRW 方法都调用他呢?</p>
<p>这个就是 Clover 需要做的,我要将所有原来调用 GPRW 方法的都调用到这个 SSDT-PRW 来,原来的 GPRW 我们更名为 XPRW.</p>
<p>明白了吧?所有代码都经过上面的逻辑,最终跑回被我们更名为 XPRW 的方法(也就是原来的GPRW 方法).</p>
<p>故此应用这个 SSDT 之前,我们需要将 DSDT 原来的 GPRW 方法重命名为 XPRW 方法</p>
<p>但是由遇到了一个问题,如何定位 GPRW 方法在二进制文件 aml 中的位置呢?</p>
<blockquote>
<p>小笔记: aml 是 ASL 编程语言编译后的二进制文件,但是我们一般反编译或者 Patch都是讨论十六进制,因为每8个二进制代表一个字符</p>
</blockquote>
<p>RehabMan 在 <a href="https://www.tonymacx86.com/threads/guide-using-clover-to-hotpatch-acpi.200137/" target="_blank" rel="external">[Guide] Using Clover to “hotpatch” ACPI</a> <strong>Rename and Replace</strong> 章节有讲到这个问题</p>
<p>大概的意思就是因为不同主板可能情况不同,我们需要使用 <a href="https://github.com/ridiculousfish/HexFiend" target="_blank" rel="external">Hex Fiend</a> 这样的软件来验证 GPRW 方法的十六进制代码.</p>
<p>方法就是用 Hex Fiend 打开 DSDT 的 aml 文件,然后搜索 GPRW, 你会看到有很多 GPRW, 我的 GPRW 方法在 DSDT 的最下面,所以我直接拉到最下面反向搜索.</p>
<p>最终找到以下十六进制代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">47 50 52 57 02      GPRW</div></pre></td></tr></table></figure>
<p>再看看 GPRW 的十六进制代码是怎么样的?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">neros-MBP:<span class="built_in">test</span> nero$ <span class="built_in">echo</span> -n GPRW|xxd</div><div class="line">00000000: 4750 5257                                GPRW</div></pre></td></tr></table></figure>
<p>奇怪了,为何我在上面列举的代码多了一个 02 ?</p>
<p>我们看看原来 GPRW 方法源代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Method (GPRW, 2, NotSerialized)</div><div class="line">&#123;</div><div class="line">    Store (Arg0, Index (PRWP, Zero))</div><div class="line">    Store (ShiftLeft (SS1, One), Local0)</div><div class="line">    Or (Local0, ShiftLeft (SS2, 0x02), Local0)</div><div class="line">    Or (Local0, ShiftLeft (SS3, 0x03), Local0)</div><div class="line">    Or (Local0, ShiftLeft (SS4, 0x04), Local0)</div><div class="line">    If (And (ShiftLeft (One, Arg1), Local0))</div><div class="line">    &#123;</div><div class="line">        Store (Arg1, Index (PRWP, One))</div><div class="line">    &#125;</div><div class="line">    Else</div><div class="line">    &#123;</div><div class="line">        ShiftRight (Local0, One, Local0)</div><div class="line">        FindSetLeftBit (Local0, Index (PRWP, One))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Return (PRWP)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看到了吧,方法名称紧挨着就是2,这个2就是 02.</p>
<p><strong>发现下面的方法好像并不是所有都这样,需要验证.</strong></p>
<p><del>根据上述帖子内容,aml 编译后会留下一个位置符来定义这个前面这个字符到底是方法,还是变量,还是设备.</del></p>
<p><del>根据我观察所得,(不同的 ASL 版本或者不同电脑获得的位置符号未必相同)</del></p>
<p>~~<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Method  位置符号是   06  [xx xx xx xx]</div><div class="line">Name    位置符号是   08  [xx xx xx xx]</div><div class="line">```~~</div><div class="line"></div><div class="line">~~搜索 `06 47 50 52 57`~~</div><div class="line"></div><div class="line">~~一样可以定位到 GPRW 方法上,而且这个代码是唯一的,因为整个 DSDT 里面只有一个 GPRW 函数.~~</div><div class="line"></div><div class="line">**翻看 RM 的帖子,再验证了下,发现一个更好的规律和方法**</div><div class="line"></div><div class="line">将我们的 DSDT.dsl 文件使用如下命令编译.</div></pre></td></tr></table></figure></p>
<p>iasl -l DSDT.dsl<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">它会产生两个文件</div><div class="line"></div><div class="line">* DSDT.aml 编译后文件</div><div class="line">* DSDT.lst 混合列表文件</div><div class="line"></div><div class="line">用文字编辑软件打开 DSDT.lst, 会发现机械码和 iASL 代码混合在一齐,这个就是一个翻译文件一样,列举了各种代码的机械码模式,这样我们就可以更好的找到我们需要打补丁的代码原来是怎么样的.</div><div class="line"></div><div class="line">例如:我们需要将 `Method (TACH,1` 的方法重命名为 `Method(XACH,1` 来使得 TACH 方法失效,再注入 SSDT 中写入 TACH 方法,来代替它.</div><div class="line"></div><div class="line">那么我只需要搜索 **Method (TACH,1** 就能找到他机械码的模样.</div></pre></td></tr></table></figure></p>
<p>   22490:          }<br>   22492:          Method (TACH, 1, Serialized)</p>
<p>00015565:  14 40 06 54 41 43 48 09     “.@.TACH.”<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">那么我们补丁就可以这样写</div></pre></td></tr></table></figure></p>
<p>Find:14 40 06 54 41 43 48 09<br>Replace:14 40 06 58 41 43 48 09<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">将我们字符转换成 Hex 形式可以用如下命令</div></pre></td></tr></table></figure></p>
<p>neros-MBP:~ nero$ echo -n TACH |xxd<br>00000000: 5441 4348                                TACH<br>neros-MBP:~ nero$ echo -n XACH |xxd<br>00000000: 5841 4348                                XACH<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">**小结**</div><div class="line"></div><div class="line">说了那么多,这个 USB3_PRW 0X6D(instant wake) 唤醒补丁的 Hotpatch 的方法就是</div><div class="line"></div><div class="line">1. 将 DSDT 的 GPRW 方法重命名为 XPRW</div><div class="line">2. 放入 RehabMan 写的 SSDT-PRW.aml 到 Clover &gt; ACPI &gt; patch  </div><div class="line"></div><div class="line">**PS: 后来测试发现开机的时候系统日志会提示没有找到 UPRW ,这个是因为 SSDT-PRW.aml 包含了 UPRW 这个方法,而这个方法对我来说是没用的,故此放入 SSDT-PRW.aml 后如果不想出现 ACPI Error 的话,最好确认下自己的唤醒是调用 GPRW 还是 UPRW,然后将另一个方法注释掉.**</div><div class="line"></div><div class="line">## SMBUS Fix</div><div class="line"></div><div class="line">这个补丁就是在 SBUS 加入 BUS0 设备,只需要放入 SSDT-SMBUS.aml 即可.</div><div class="line"></div><div class="line">## Rename B0D3 to HDAU</div><div class="line"></div><div class="line">先将 B0D3 重命名为 HDAU</div></pre></td></tr></table></figure></p>
<p>Comment: change B0D3 to HDAU, optionally pair with SSDT-HDAU.aml<br>Find: 42304433<br>Replace: 48444155<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">再放入 SSDT-HDAU.aml</div><div class="line"></div><div class="line">**注意修改 layout-id 的值为你声卡的 layout-id 值,我声卡的 layout-id 是4**</div><div class="line"></div><div class="line">```iASL</div><div class="line">// Automatic injection of HDAU properties</div><div class="line"></div><div class="line">// Note: Only for Haswell and Broadwell</div><div class="line"></div><div class="line">DefinitionBlock(&quot;&quot;, &quot;SSDT&quot;, 2, &quot;hack&quot;, &quot;HDAU&quot;, 0)</div><div class="line">&#123;</div><div class="line">    External(_SB.PCI0.HDAU, DeviceObj)</div><div class="line">    External(RMCF.AUDL, IntObj)</div><div class="line"></div><div class="line">    // inject properties for audio</div><div class="line">    Method(_SB.PCI0.HDAU._DSM, 4)</div><div class="line">    &#123;</div><div class="line">        If (CondRefOf(\RMCF.AUDL)) &#123; If (Ones == \RMCF.AUDL) &#123; Return(0) &#125; &#125;</div><div class="line">        If (!Arg2) &#123; Return (Buffer() &#123; 0x03 &#125; ) &#125;</div><div class="line">        Local0 = Package()</div><div class="line">        &#123;</div><div class="line">            &quot;layout-id&quot;, Buffer(4) &#123; 4, 0, 0, 0 &#125;, //需要注意修改此 layout-id 值</div><div class="line">            &quot;hda-gfx&quot;, Buffer() &#123; &quot;onboard-1&quot; &#125;,</div><div class="line">        &#125;</div><div class="line">        If (CondRefOf(\RMCF.AUDL))</div><div class="line">        &#123;</div><div class="line">            CreateDWordField(DerefOf(Local0[1]), 0, AUDL)</div><div class="line">            AUDL = \RMCF.AUDL</div><div class="line">        &#125;</div><div class="line">        Return(Local0)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">//EOF</div></pre></td></tr></table></figure></p>
<h2 id="ApplePS2SmartTouchPad-驱动的-Fn-按键补丁"><a href="#ApplePS2SmartTouchPad-驱动的-Fn-按键补丁" class="headerlink" title="ApplePS2SmartTouchPad 驱动的 Fn 按键补丁"></a>ApplePS2SmartTouchPad 驱动的 Fn 按键补丁</h2><p>这个补丁需要打上 Fn 功能键才能调整亮度,我们先看看补丁都干了些什么</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># Patch by EMlyDinEsH (OSXLatitude)</div><div class="line"># Enables Fn brightness keys to work with my kext AsusNBFnKeys</div><div class="line"></div><div class="line"># Replacing method _Q0E with code for Brightness down key to work</div><div class="line">into Method label _Q0E replace_content begin </div><div class="line">             If (ATKP)\n</div><div class="line">                &#123;\n</div><div class="line">                   ^^^^ATKD.IANE (0x20)\n</div><div class="line">                &#125;</div><div class="line">end;</div><div class="line"></div><div class="line"># Replacing method _Q0F with code for Brightness up key to work</div><div class="line">into Method label _Q0F replace_content begin </div><div class="line">             If (ATKP)\n</div><div class="line">                &#123;\n</div><div class="line">                   ^^^^ATKD.IANE (0x10)\n</div><div class="line">                &#125;</div><div class="line">end;</div></pre></td></tr></table></figure>
<p>上面这个补丁是将 _Q0E 方法和 _Q0F 方法的内容替换如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Method (_Q0E, 0, NotSerialized)  // _Qxx: EC Query</div><div class="line">&#123;</div><div class="line">    </div><div class="line">    If (ATKP)</div><div class="line">    &#123;</div><div class="line">        ^^^^ATKD.IANE (0x20)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">Method (_Q0F, 0, NotSerialized)  // _Qxx: EC Query</div><div class="line">&#123;</div><div class="line">    </div><div class="line">    If (ATKP)</div><div class="line">    &#123;</div><div class="line">        ^^^^ATKD.IANE (0x10)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>参考章节 USB3_PRW 0X6D(instant wake) 的方法.</p>
<ol>
<li>重命名 _Q0E 方法和 _Q0F 方法为 XQ0E 和 XQ0F,使原先的方法失效.</li>
<li>再放入我们自己定义的 _Q0E 方法和 _Q0F 方法.</li>
</ol>
<h3 id="替换-Q0E-和-Q0F-方法名称"><a href="#替换-Q0E-和-Q0F-方法名称" class="headerlink" title="替换 _Q0E 和 _Q0F 方法名称"></a>替换 _Q0E 和 _Q0F 方法名称</h3><p>命令行查找下以上两个方法的十六进制代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">neros-MacBook-Pro:hotpatch nero$ <span class="built_in">echo</span> -n _Q0E | xxd </div><div class="line">00000000: 5f51 3045                                _Q0E</div><div class="line">neros-MacBook-Pro:hotpatch nero$ <span class="built_in">echo</span> -n XQ0E | xxd </div><div class="line">00000000: 5851 3045                                XQ0E</div><div class="line">neros-MacBook-Pro:hotpatch nero$ <span class="built_in">echo</span> -n _Q0F | xxd </div><div class="line">00000000: 5f51 3046                                _Q0F</div><div class="line">neros-MacBook-Pro:hotpatch nero$ <span class="built_in">echo</span> -n XQ0F | xxd </div><div class="line">00000000: 5851 3046                                XQ0F</div></pre></td></tr></table></figure>
<p>那么在 Clover 配置文件 ACPI &gt; DSDT &gt; Patches 写入如下补丁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#补丁-1</div><div class="line">Comment: change _Q0E to XQ0E, optionally pair with SSDT-Fn.aml</div><div class="line">Find: 5f51 3045</div><div class="line">Replace: 5851 3045</div><div class="line"></div><div class="line">#补丁-2</div><div class="line">Comment: change _Q0F to XQ0F, optionally pair with SSDT-Fn.aml</div><div class="line">Find: 5f51 3046</div><div class="line">Replace: 5851 3046</div></pre></td></tr></table></figure>
<p>如果觉得不放心,可以用 Hex Fiend 打开 DSDT.aml 文件来搜索替换一下,之后再用 iasl 来反编译,再用 MaciASL dsl 文件看看,是否已经被重命名为 XQ0E 和 XQ0F</p>
<h3 id="重定义新的-Q0E-和-Q0F-方法"><a href="#重定义新的-Q0E-和-Q0F-方法" class="headerlink" title="重定义新的 _Q0E 和 _Q0F 方法"></a>重定义新的 _Q0E 和 _Q0F 方法</h3><p>我不会编写 SSDT, 但是我会抄~</p>
<p>复制一份 SSDT-PRW.dsl 下来重命名为 SSDT-FN.dsl</p>
<p>用 MaciASL 打开.</p>
<p>将其修改为如下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">//Enables Fn brightness keys to work with my kext AsusNBFnKeys</div><div class="line"></div><div class="line">DefinitionBlock(&quot;&quot;, &quot;SSDT&quot;, 2, &quot;hack&quot;, &quot;Fn&quot;, 0)</div><div class="line">&#123;</div><div class="line">    // In DSDT, native _Q0E and _Q0F is renamed to XQ0E and XQ0F with Clover binpatch.</div><div class="line">    // (or UPRW to XPRW)</div><div class="line">    // As a result, calls to _Q0E and _Q0F land here.</div><div class="line">    </div><div class="line">    External(ATKP, IntObj)</div><div class="line">    External(\_SB.ATKD.IANE, MethodObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0, DeviceObj)</div><div class="line">    </div><div class="line">    Scope(\_SB.PCI0.LPCB.EC0)</div><div class="line">    &#123;</div><div class="line">        Method (_Q0E, 0, NotSerialized)  // _Qxx: EC Query</div><div class="line">            &#123;</div><div class="line">            </div><div class="line">                If (ATKP)</div><div class="line">                &#123;</div><div class="line">                    \_SB.ATKD.IANE (0x20)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        Method (_Q0F, 0, NotSerialized)  // _Qxx: EC Query</div><div class="line">        &#123;</div><div class="line">            </div><div class="line">            If (ATKP)</div><div class="line">            &#123;</div><div class="line">                \_SB.ATKD.IANE (0x10)</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">//EOF</div></pre></td></tr></table></figure>
<p><strong>PS:以上代码纯属乱搞,如果能用,纯属巧合哈~</strong></p>
<p>最终将此 SSDT-FN.dsl 编译成 aml, 再放入 Clover &gt; ACPI &gt; patches</p>
<h2 id="电池补丁"><a href="#电池补丁" class="headerlink" title="电池补丁"></a>电池补丁</h2><h3 id="方法分析"><a href="#方法分析" class="headerlink" title="方法分析"></a>方法分析</h3><p>根据远景论坛的教学贴,我学会了编写自己笔记本的电池电量补丁.</p>
<p>以下是我 华硕 VM510LI 的电量补丁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line">#Maintained by: Nero for: Laptop Patches</div><div class="line">#battery_ASUS-VM510LI.txt</div><div class="line"></div><div class="line"># created by Nero 1/2017</div><div class="line"></div><div class="line">#Create B1B2 Method</div><div class="line">into method label B1B2 remove_entry;</div><div class="line">into definitionblock code_regex . insert</div><div class="line">begin</div><div class="line">Method (B1B2, 2, NotSerialized)\n</div><div class="line">&#123;\n</div><div class="line">Return(Or(Arg0, ShiftLeft(Arg1, 8)))\n</div><div class="line">&#125;\n</div><div class="line">end;</div><div class="line"></div><div class="line"># utility methods to read/write buffers from/to EC</div><div class="line">into method label RE1B parent_label EC0 remove_entry;</div><div class="line">into method label RECB parent_label EC0 remove_entry;</div><div class="line">into device label EC0 insert</div><div class="line">begin</div><div class="line">Method (RE1B, 1, NotSerialized)\n</div><div class="line">&#123;\n</div><div class="line">    OperationRegion(ERAM, EmbeddedControl, Arg0, 1)\n</div><div class="line">    Field(ERAM, ByteAcc, NoLock, Preserve) &#123; BYTE, 8 &#125;\n</div><div class="line">    Return(BYTE)\n</div><div class="line">&#125;\n</div><div class="line">Method (RECB, 2, Serialized)\n</div><div class="line">&#123;\n</div><div class="line">    ShiftRight(Arg1, 3, Arg1)\n</div><div class="line">    Name(TEMP, Buffer(Arg1) &#123; &#125;)\n</div><div class="line">    Add(Arg0, Arg1, Arg1)\n</div><div class="line">    Store(0, Local0)\n</div><div class="line">    While (LLess(Arg0, Arg1))\n</div><div class="line">    &#123;\n</div><div class="line">        Store(RE1B(Arg0), Index(TEMP, Local0))\n</div><div class="line">        Increment(Arg0)\n</div><div class="line">        Increment(Local0)\n</div><div class="line">    &#125;\n</div><div class="line">    Return(TEMP)\n</div><div class="line">&#125;\n</div><div class="line">end;</div><div class="line"></div><div class="line"># utility method to write to EC buffers</div><div class="line">into method label WE1B parent_label EC0 remove_entry;</div><div class="line">into method label WECB parent_label EC0 remove_entry;</div><div class="line">into device label EC0 insert</div><div class="line">begin</div><div class="line">Method (WE1B, 2, NotSerialized)\n</div><div class="line">&#123;\n</div><div class="line">    OperationRegion(ERAM, EmbeddedControl, Arg0, 1)\n</div><div class="line">    Field(ERAM, ByteAcc, NoLock, Preserve) &#123; BYTE, 8 &#125;\n</div><div class="line">    Store(Arg1, BYTE)\n</div><div class="line">&#125;\n</div><div class="line">Method (WECB, 3, Serialized)\n</div><div class="line">&#123;\n</div><div class="line">    ShiftRight(Arg1, 3, Arg1)\n</div><div class="line">    Name(TEMP, Buffer(Arg1) &#123; &#125;)\n</div><div class="line">    Store(Arg2, TEMP)\n</div><div class="line">    Add(Arg0, Arg1, Arg1)\n</div><div class="line">    Store(0, Local0)\n</div><div class="line">    While (LLess(Arg0, Arg1))\n</div><div class="line">    &#123;\n</div><div class="line">        WE1B(Arg0, DerefOf(Index(TEMP, Local0)))\n</div><div class="line">        Increment(Arg0)\n</div><div class="line">        Increment(Local0)\n</div><div class="line">    &#125;\n</div><div class="line">&#125;\n</div><div class="line">end;</div><div class="line"></div><div class="line">#Convert 16 bit to 8 bit registers</div><div class="line">into device label EC0 code_regex TAH0,\s+16, replace_matched begin TA00,8,TA01,8, end;</div><div class="line">into device label EC0 code_regex TAH1,\s+16, replace_matched begin TA20,8,TA21,8, end;</div><div class="line">into device label EC0 code_regex B0C3,\s+16, replace_matched begin B001,8,B002,8, end;</div><div class="line">into device label EC0 code_regex B0SN,\s+16, replace_matched begin B0S0,8,B0S1,8, end;</div><div class="line">into device label EC0 code_regex B1SN,\s+16 replace_matched begin B1S0,8,B1S1,8 end;</div><div class="line">into device label EC0 code_regex DT2B,\s+16 replace_matched begin DT01,8,DT02,8 end;</div><div class="line"></div><div class="line">#Fix 16 bit registers</div><div class="line">into method label TACH code_regex \(TAH0, replaceall_matched begin (B1B2(TA00,TA01), end;</div><div class="line">into method label TACH code_regex \(TAH1, replaceall_matched begin (B1B2(TA20,TA21), end;</div><div class="line">into method label _BIX code_regex \^\^LPCB.EC0.B0C3, replaceall_matched begin B1B2(^^LPCB.EC0.B001,^^LPCB.EC0.B002), end;</div><div class="line">into method label BIFA code_regex \(B0SN, replaceall_matched begin (B1B2(B0S0,B0S1), end;</div><div class="line">into method label BIFA code_regex \(B1SN, replaceall_matched begin (B1B2(B1S0,B1S1), end;</div><div class="line">into method label SMBR code_regex \(DT2B, replaceall_matched begin (B1B2(DT01,DT02), end;</div><div class="line">into method label SMBW code_regex Store\s\(Arg4,\sDT2B\) replaceall_matched begin Store (ShiftRight(Arg4,8),DT02)\nStore (Arg4,DT01) end;</div><div class="line"></div><div class="line">#fix 256 bit registers</div><div class="line">into method label SMBR code_regex Store\s+\((.*),\s+BDAT\) replaceall_matched begin WECB(0x1c,256,%1) end;</div><div class="line">into method label SMBW code_regex Store\s+\((.*),\s+BDAT\) replaceall_matched begin WECB(0x1c,256,%1) end;</div><div class="line">into method label ECSB code_regex Store\s+\((.*),\s+BDAT\) replaceall_matched begin WECB(0x1c,256,%1) end;</div><div class="line">into method label ECSB code_regex Store\s+\((.*),\s+BDA2\) replaceall_matched begin WECB(0x44,256,%1) end;</div><div class="line">into method label ECSB code_regex \(BDAT, replaceall_matched begin (RECB(0x1c,256), end;</div><div class="line">into method label ECSB code_regex \(BDA2, replaceall_matched begin (RECB(0x44,256), end;</div><div class="line">into method label SMBR code_regex \(BDAT, replaceall_matched begin (RECB(0x1c,256), end;</div></pre></td></tr></table></figure>
<p>大家都知道电量修补是一项非常复杂的修改,需要将调用到的变量高于8位的数值拆分成8位来处理.</p>
<p>故此修改代码量非常多,并且变量名称均需要重命名及重新赋值.</p>
<p>Hotpatch 因为是注入 SSDT 来实现补丁效果,故此我们需要找到补丁修改的各个变量赋值与函数调用的变量.</p>
<p>RM 教给大家一个办法,先将 DSDT.dsl 打上电池补丁,然后另存为 DSDT-Patch.dsl 然后使用 <a href="http://www.diffmerge.net/" target="_blank" rel="external">DiffMerge</a> 来对比两个文件的修改代码的情况,就可以最简单的知道补丁到底修改了哪些变量.</p>
<p>当然读懂补丁的语法其实并不需要这样做,我们可以读一下补丁到底修改了哪些变量,做了哪些操作就可以了,这个补丁是我自己写的,所以我并不需要用 DiffMerge 来查询.</p>
<p>经过研究,我发现单纯用 Clover Patches 方式来修改变量是行不通的,因为例如 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//拆分前</div><div class="line">TAH0,16         Hex: 54 41 48 30 10</div><div class="line"></div><div class="line">//拆分后</div><div class="line">TA01,8,TA02,8   Hex: 54 41 30 31 08 54 41 30 32 08</div></pre></td></tr></table></figure>
<p>拆分前是占用5个字节,拆分后我们需要10个字节的空间,这样打补丁的话,会导致 TAH0 下面的变量被覆盖,导致出错.</p>
<p>那么如此大量的变量更改,我们应当如何修改呢?</p>
<p>我参考了 RM 给 HP ProBook 的电量补丁以及 Hotpatch 电量修补 SSDT</p>
<p>SSDT:<a href="https://raw.githubusercontent.com/RehabMan/HP-ProBook-4x30s-DSDT-Patch/master/hotpatch/SSDT-BATT.dsl" target="_blank" rel="external">https://raw.githubusercontent.com/RehabMan/HP-ProBook-4x30s-DSDT-Patch/master/hotpatch/SSDT-BATT.dsl</a></p>
<p>电量补丁:<a href="https://raw.githubusercontent.com/RehabMan/HP-ProBook-4x30s-DSDT-Patch/master/patches/06_Battery.txt" target="_blank" rel="external">https://raw.githubusercontent.com/RehabMan/HP-ProBook-4x30s-DSDT-Patch/master/patches/06_Battery.txt</a></p>
<p>发现他的解决办法如下</p>
<ol>
<li>新建一个 SSDT 写入 EC 方法,方法中赋予我们拆分后的电池变量.</li>
<li>在新建的 SSDT 中复制修改好的方法.</li>
<li>利用 MaciASL 编译功能来协助检查缺少的 External().</li>
<li>将原来调用电池变量的方法一一用 Clover Patches 更名(将原来的方法全部禁用).</li>
</ol>
<h3 id="将-EC-赋值的需要拆分的变量写入到-SSDT-BATT-dsl"><a href="#将-EC-赋值的需要拆分的变量写入到-SSDT-BATT-dsl" class="headerlink" title="将 EC 赋值的需要拆分的变量写入到 SSDT-BATT.dsl"></a>将 EC 赋值的需要拆分的变量写入到 SSDT-BATT.dsl</h3><p>我不会写 SSDT, 但是我会抄.抄 RM 写的 SSDT 再修改</p>
<p>下面是 EC0 设备拆分后的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">// battery status patched for Ausu VM510LI</div><div class="line"></div><div class="line">DefinitionBlock (&quot;&quot;, &quot;SSDT&quot;, 2, &quot;hack&quot;, &quot;batt&quot;, 0)</div><div class="line">&#123;</div><div class="line">    External(\_SB.PCI0, DeviceObj)</div><div class="line">    External(\_SB.PCI0.LPCB, DeviceObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0, DeviceObj)</div><div class="line"></div><div class="line">    Scope(\_SB.PCI0.LPCB.EC0)</div><div class="line">    &#123;</div><div class="line">        // This is an override for battery methods that access EC fields</div><div class="line">        // larger than 8-bit.</div><div class="line">        OperationRegion (ECOR, EmbeddedControl, Zero, 0xFF)</div><div class="line">        Field (ECOR, ByteAcc, Lock, Preserve)</div><div class="line">        &#123;</div><div class="line">            //Offset (0x04), </div><div class="line">            //CMD1,   8, </div><div class="line">            //...</div><div class="line">            Offset (0x93),</div><div class="line">            TA00,8,TA01,8, </div><div class="line">            TA20,8,TA21,8, </div><div class="line">            //...</div><div class="line">            Offset (0xBE), </div><div class="line">            ,   16, //B0TM,   16</div><div class="line">            ,   16, //B0C1,   16,</div><div class="line">            ,   16, //B0C2,   16,</div><div class="line">            B001,8,B002,8, </div><div class="line">            //...</div><div class="line">            Offset (0xF4), </div><div class="line">            B0S0,8,B0S1,8, </div><div class="line">            //Offset (0xF8), </div><div class="line">            //Offset (0xFA), </div><div class="line">            Offset (0xFC), </div><div class="line">            B1S0,8,B1S1,8</div><div class="line">        &#125;</div><div class="line">        OperationRegion (SMBX, EmbeddedControl, 0x18, 0x28)</div><div class="line">        Field (SMBX, ByteAcc, NoLock, Preserve)</div><div class="line">        &#123;</div><div class="line">            Offset (0x04), </div><div class="line">            DT01,8,DT02,8</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 <code>OperationRegion (ECOR, EmbeddedControl, Zero, 0xFF)</code> 和 <code>OperationRegion (SMBX, EmbeddedControl, 0x18, 0x28)</code> 原来的 DSDT 都存在,按照 RM 修改的方法,他的方式应该是从每个 <code>Offset (0X00)</code> 偏移量定义去写,如果偏移量下面第四个才是需要拆的,那么上面的可以使用 <code>,   16,</code> 这种方法来代替偏移量,好像这样就不会覆盖到原先的变量.(猜测罢了)</p>
<blockquote>
<p>2017年04月30日：根据远景坛友 gujiangjiang 提醒，EC Field需要改个名字才能用，不然无效，会出现很多ACPI Error。</p>
</blockquote>
<p>将上述的 ECOR 和 SMBX 重命名。</p>
<p>在 Clover DSDT Patches 添加如下补丁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Comment:change ECOR to XCOR</div><div class="line">Find:45434F52 </div><div class="line">Replace:58434F52 </div><div class="line"></div><div class="line">Comment:change SMBX to XMBX</div><div class="line">Find:534D4258 </div><div class="line">Replace:584D4258</div></pre></td></tr></table></figure>
<h3 id="将调用了以上变量的方法复制到-SSDT-BATT-dsl"><a href="#将调用了以上变量的方法复制到-SSDT-BATT-dsl" class="headerlink" title="将调用了以上变量的方法复制到 SSDT-BATT.dsl"></a>将调用了以上变量的方法复制到 SSDT-BATT.dsl</h3><p>从已经打了电量补丁的 DSDT 中找出上方调用这些变量的方法所在地,不要忘记了补丁中 #fix 256 bit registers 的方法,因为电量补丁中,大于32的变量无需拆分,只需要将调动变量的代码用 WECB 方法与 RECB 方法来更改代替即可.</p>
<ul>
<li>Method (TACH, 1, Serialized)<ul>
<li>TA00</li>
<li>TA01</li>
<li>TA20</li>
<li>TA21</li>
</ul>
</li>
<li>Method (_BIX, 0, NotSerialized)<ul>
<li>B001</li>
<li>B002</li>
</ul>
</li>
<li>Method (BIFA, 0, NotSerialized)<ul>
<li>B0S0</li>
<li>B0S1</li>
<li>B1S0</li>
<li>B1S1</li>
</ul>
</li>
<li>Method (SMBR, 3, Serialized)<ul>
<li>WECB(0x1c,256,Zero)</li>
<li>WECB(0x1c,256,Zero)</li>
<li>WECB(0x1c,256,Arg4)</li>
<li>Store (RECB(0x1c,256), Index (Local0, 0x02))</li>
</ul>
</li>
<li>Method (ECSB, 7, NotSerialized)<ul>
<li>WECB(0x1c,256,DerefOf (Index (Arg6, One)))</li>
<li>WECB(0x44,256,DerefOf (Index (Arg6, One)))</li>
<li>Store (RECB(0x1c,256), Index (Local1, 0x04))</li>
<li>Store (RECB(0x44,256), Index (Local1, 0x04))</li>
</ul>
</li>
<li>Method (SMBW, 5, Serialized)<ul>
<li>Store (ShiftRight(Arg4,8),DT02)</li>
<li>Store (Arg4,DT01)</li>
</ul>
</li>
</ul>
<p>总共发现6个方法,我们将这6个方法一个一个从修不好电量补丁的 DSDT 中复制到 SSDT-BATT.dsl</p>
<p>TACH 方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">Method (TACH, 1, Serialized)</div><div class="line">&#123;</div><div class="line">    Name (_T_0, Zero)  // _T_x: Emitted by ASL Compiler</div><div class="line">    If (ECAV ())</div><div class="line">    &#123;</div><div class="line">        While (One)</div><div class="line">        &#123;</div><div class="line">            Store (Arg0, _T_0)</div><div class="line">            If (LEqual (_T_0, Zero))</div><div class="line">            &#123;</div><div class="line">                Store (B1B2(TA00,TA01), Local0)</div><div class="line">                Break</div><div class="line">            &#125;</div><div class="line">            ElseIf (LEqual (_T_0, One))</div><div class="line">            &#123;</div><div class="line">                Store (B1B2(TA20,TA21), Local0)</div><div class="line">                Break</div><div class="line">            &#125;</div><div class="line">            Else</div><div class="line">            &#123;</div><div class="line">                Return (Ones)</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Break</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Multiply (Local0, 0x02, Local0)</div><div class="line">        If (LNotEqual (Local0, Zero))</div><div class="line">        &#123;</div><div class="line">            Divide (0x0041CDB4, Local0, Local1, Local0)</div><div class="line">            Return (Local0)</div><div class="line">        &#125;</div><div class="line">        Else</div><div class="line">        &#123;</div><div class="line">            Return (Ones)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    Else</div><div class="line">    &#123;</div><div class="line">        Return (Ones)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当你复制这个方法到 SSDT-BATT.dsl 时候,编译时会遇到一个错误.(这里我已经将拆分需要的 B1B2,WE1B,WECB,RE1B,RECB 等方法放入 <code>Scope(\_SB.PCI0.LPCB.EC0)</code> 域里面)</p>
<p><strong>49, 6084, Object does not exist (ECAV)</strong></p>
<p>看看 ECAV 是哪行调用的.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Name (_T_0, Zero)  // _T_x: Emitted by ASL Compiler</div><div class="line">If (ECAV ())</div><div class="line">&#123;</div></pre></td></tr></table></figure>
<p>这个是一个判断语句内嵌了一个方法的调用,初步判断 ECAV 就是一个方法,那么这个方法在哪里呢?回到我们的 DSDT.dsl</p>
<p>搜索 ECAV ,你会在 _SB.PCI0.LPCB.EC0 中发现 ECAV 这个方法,那么我们需要在 SSDT-BATT.dsl 中外部引入这个方法,来达到编译通过的目的.</p>
<p>只需要在 TACH 上方写入 <code>External(\_SB.PCI0.LPCB.EC0.ECAV, MethodObj)</code></p>
<p>再次编译,已通过编译.</p>
<p>我们需要注意的是外部引入的路径与外部引入的类型.</p>
<p>路径在 MaciASL 中,只要你光标移动到这个方法上,程序的左下角会显示当前方法(或变量)所在的路径.</p>
<p>一般 Name ( ABCD , 0X10) 这类的变量引入我们使用 IntObj 类型引入.</p>
<p>而上述的 Method (ECAV, 0, NotSerialized) 这一类,当然是使用 MethodObj 类型引入了.</p>
<p><strong>注意,复制方法过来的时候,需要注意该方法本来是在哪个域里面的,我们在 SSDT-BATT.dsl 也要将其放到哪个域里</strong></p>
<p>例如:Method (_BIX, 0, NotSerialized)</p>
<p>这个方法是在 _SB.PCI0.BAT0 这个域里面,那么我们需要将_BIX 方法放在这个域里面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">External(\_SB.PCI0, DeviceObj)</div><div class="line">External(\_SB.PCI0.BAT0, DeviceObj)</div><div class="line"></div><div class="line">    Scope(\_SB.PCI0.BAT0)</div><div class="line">    &#123;</div><div class="line">            Method (_BIX, 0, NotSerialized)  // _BIX: Battery Information Extended</div><div class="line">            &#123;</div><div class="line">                If (LNot (^^LPCB.EC0.BATP (Zero)))</div><div class="line">                &#123;</div><div class="line">                    Return (NBIX)</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                If (LEqual (^^LPCB.EC0.GBTT (Zero), 0xFF))</div><div class="line">                &#123;</div><div class="line">                    Return (NBIX)</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                _BIF ()</div><div class="line">                Store (DerefOf (Index (PBIF, Zero)), Index (BIXT, One))</div><div class="line">                Store (DerefOf (Index (PBIF, One)), Index (BIXT, 0x02))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x02)), Index (BIXT, 0x03))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x03)), Index (BIXT, 0x04))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x04)), Index (BIXT, 0x05))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x05)), Index (BIXT, 0x06))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x06)), Index (BIXT, 0x07))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x07)), Index (BIXT, 0x0E))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x08)), Index (BIXT, 0x0F))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x09)), Index (BIXT, 0x10))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x0A)), Index (BIXT, 0x11))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x0B)), Index (BIXT, 0x12))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x0C)), Index (BIXT, 0x13))</div><div class="line">                If (LEqual (DerefOf (Index (BIXT, One)), One))</div><div class="line">                &#123;</div><div class="line">                    Store (Zero, Index (BIXT, One))</div><div class="line">                    Store (DerefOf (Index (BIXT, 0x05)), Local0)</div><div class="line">                    Multiply (DerefOf (Index (BIXT, 0x02)), Local0, Index (BIXT, 0x02))</div><div class="line">                    Multiply (DerefOf (Index (BIXT, 0x03)), Local0, Index (BIXT, 0x03))</div><div class="line">                    Multiply (DerefOf (Index (BIXT, 0x06)), Local0, Index (BIXT, 0x06))</div><div class="line">                    Multiply (DerefOf (Index (BIXT, 0x07)), Local0, Index (BIXT, 0x07))</div><div class="line">                    Multiply (DerefOf (Index (BIXT, 0x0E)), Local0, Index (BIXT, 0x0E))</div><div class="line">                    Multiply (DerefOf (Index (BIXT, 0x0F)), Local0, Index (BIXT, 0x0F))</div><div class="line">                    Divide (DerefOf (Index (BIXT, 0x02)), 0x03E8, Local0, Index (BIXT, 0x02))</div><div class="line">                    Divide (DerefOf (Index (BIXT, 0x03)), 0x03E8, Local0, Index (BIXT, 0x03))</div><div class="line">                    Divide (DerefOf (Index (BIXT, 0x06)), 0x03E8, Local0, Index (BIXT, 0x06))</div><div class="line">                    Divide (DerefOf (Index (BIXT, 0x07)), 0x03E8, Local0, Index (BIXT, 0x07))</div><div class="line">                    Divide (DerefOf (Index (BIXT, 0x0E)), 0x03E8, Local0, Index (BIXT, 0x0E))</div><div class="line">                    Divide (DerefOf (Index (BIXT, 0x0F)), 0x03E8, Local0, Index (BIXT, 0x0F))</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                Store (B1B2(^^LPCB.EC0.B001,^^LPCB.EC0.B002), Index (BIXT, 0x08))</div><div class="line">                Store (0x0001869F, Index (BIXT, 0x09))</div><div class="line">                Return (BIXT)</div><div class="line">            &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>复制了之后,我们还有非常多的错误需要处理</p>
<ul>
<li>135, 6085, Object not found or not accessible from scope (^^LPCB.EC0.BATP)</li>
</ul>
<p>代码段: If (LNot (^^LPCB.EC0.BATP (Zero)))</p>
<p>^^LPCB.EC0.BATP 这个方法写法中存在 ^^这两个字符,意思上级的上级域里面的,类似于相对路径, LPCB.EC.BATP 方法,完整路径就是 _SB.PCI0.LPCB.EC0.BATP,因为这个方法不在我们的 SSDT 里面,故此我们需要外部引入他.在 External 的部分加入 <code>External(\_SB.PCI0.LPCB.EC0.BATP, MethodObj)</code></p>
<p>但是上面的 ^^LPCB.EC0.BATP 这样的调用方法猜测应该是同一 SSDT 或是在 DSDT 中存在才能这样写,如果是外部引入后,我们需要将其改成绝对路径.</p>
<p>将 <code>^^LPCB.EC0.BATP</code> 替换成 <code>\_SB.PCI0.LPCB.EC0.BATP</code>.</p>
<ul>
<li>140, 6084, Object does not exist (NBIX)</li>
</ul>
<p>代码段:Return (NBIX)</p>
<p>这个返回值应该是一个变量,我们看看 DSDT 下他是如何定义的.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">Name (NBIX, Package (0x14)</div><div class="line">            &#123;</div><div class="line">                Zero, </div><div class="line">                Zero, </div><div class="line">                0xFFFFFFFF, </div><div class="line">                0xFFFFFFFF, </div><div class="line">                One, </div><div class="line">                0xFFFFFFFF, </div><div class="line">                0xFFFFFFFF, </div><div class="line">                0xFFFFFFFF, </div><div class="line">                Zero, </div><div class="line">                0xFFFFFFFF, </div><div class="line">                0xFFFFFFFF, </div><div class="line">                0xFFFFFFFF, </div><div class="line">                0xFFFFFFFF, </div><div class="line">                0xFFFFFFFF, </div><div class="line">                0xFFFFFFFF, </div><div class="line">                0xFFFFFFFF, </div><div class="line">                &quot;&quot;, </div><div class="line">                &quot;&quot;, </div><div class="line">                &quot;&quot;, </div><div class="line">                &quot;&quot;</div><div class="line">            &#125;)</div></pre></td></tr></table></figure>
<p><strong>Name (NBIX, Package (0x14)</strong> 它是一个对象集,对象集引入的类型应当是 PkgObj</p>
<p>在头部外部引入部分加入  <code>External(\_SB.PCI0.BAT0.NBIX, PkgObj)</code></p>
<p>剩下错误用同类的方法修补</p>
<p>最终复制完整个 SSDT-BATT.dsl 是这样的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div></pre></td><td class="code"><pre><div class="line">// battery status patched for Ausu VM510LI</div><div class="line"></div><div class="line">DefinitionBlock (&quot;&quot;, &quot;SSDT&quot;, 2, &quot;hack&quot;, &quot;batt&quot;, 0)</div><div class="line">&#123;</div><div class="line">    External(\BSLF, IntObj)</div><div class="line">    External(\_SB.PCI0, DeviceObj)</div><div class="line">    External(\_SB.PCI0.BAT0, DeviceObj)</div><div class="line">    External(\_SB.PCI0.BAT0.NBIX, PkgObj)</div><div class="line">    External(\_SB.PCI0.BAT0.PBIF, PkgObj)</div><div class="line">    External(\_SB.PCI0.BAT0.BIXT, PkgObj)</div><div class="line">    External(\_SB.PCI0.BAT0._BIF, MethodObj)</div><div class="line">    External(\_SB.PCI0.LPCB, DeviceObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0, DeviceObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.ECAV, MethodObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.BATP, MethodObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.GBTT, MethodObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.RDBL, IntObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.RDWD, IntObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.RDBT, IntObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.RCBT, IntObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.RDQK, IntObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.MUEC, MutexObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.PRTC, FieldUnitObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.SBBY, IntObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.ADDR, FieldUnitObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.CMDB, FieldUnitObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.SWTC, MethodObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.BCNT, FieldUnitObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.DAT0, FieldUnitObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.PRT2, FieldUnitObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.DAT1, FieldUnitObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.ADD2, FieldUnitObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.CMD2, FieldUnitObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.BCN2, FieldUnitObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.DA20, FieldUnitObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.DA21, FieldUnitObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.SSTS, FieldUnitObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.SST2, FieldUnitObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.WRBL, IntObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.WRWD, IntObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.WRBT, IntObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.SDBT, IntObj)</div><div class="line">    External(\_SB.PCI0.LPCB.EC0.WRQK, IntObj)</div><div class="line">    </div><div class="line">    </div><div class="line">    Scope(\_SB.PCI0.LPCB.EC0)</div><div class="line">    &#123;</div><div class="line">        // This is an override for battery methods that access EC fields</div><div class="line">        // larger than 8-bit.</div><div class="line">        OperationRegion (ECOR, EmbeddedControl, Zero, 0xFF)</div><div class="line">        Field (ECOR, ByteAcc, Lock, Preserve)</div><div class="line">        &#123;</div><div class="line">            //Offset (0x04), </div><div class="line">            //CMD1,   8, </div><div class="line">            //...</div><div class="line">            Offset (0x93),</div><div class="line">            TA00,8,TA01,8, </div><div class="line">            TA20,8,TA21,8, </div><div class="line">            //...</div><div class="line">            Offset (0xBE), </div><div class="line">            ,   16, //B0TM,   16</div><div class="line">            ,   16, //B0C1,   16,</div><div class="line">            ,   16, //B0C2,   16,</div><div class="line">            B001,8,B002,8, </div><div class="line">            //...</div><div class="line">            Offset (0xF4), </div><div class="line">            B0S0,8,B0S1,8, </div><div class="line">            //Offset (0xF8), </div><div class="line">            //Offset (0xFA), </div><div class="line">            Offset (0xFC), </div><div class="line">            B1S0,8,B1S1,8</div><div class="line">        &#125;</div><div class="line">        OperationRegion (SMBX, EmbeddedControl, 0x18, 0x28)</div><div class="line">        Field (SMBX, ByteAcc, NoLock, Preserve)</div><div class="line">        &#123;</div><div class="line">            Offset (0x04), </div><div class="line">            DT01,8,DT02,8</div><div class="line">        &#125;</div><div class="line">             </div><div class="line">        // TACH methods are renamed in native DSDT, so calls land here...</div><div class="line">        Method (TACH, 1, Serialized)</div><div class="line">        &#123;</div><div class="line">            Name (_T_0, Zero)  // _T_x: Emitted by ASL Compiler</div><div class="line">            If (ECAV ())</div><div class="line">            &#123;</div><div class="line">                While (One)</div><div class="line">                &#123;</div><div class="line">                    Store (Arg0, _T_0)</div><div class="line">                    If (LEqual (_T_0, Zero))</div><div class="line">                    &#123;</div><div class="line">                        Store (B1B2(TA00,TA01), Local0)</div><div class="line">                        Break</div><div class="line">                    &#125;</div><div class="line">                    ElseIf (LEqual (_T_0, One))</div><div class="line">                    &#123;</div><div class="line">                        Store (B1B2(TA20,TA21), Local0)</div><div class="line">                        Break</div><div class="line">                    &#125;</div><div class="line">                    Else</div><div class="line">                    &#123;</div><div class="line">                        Return (Ones)</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    Break</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                Multiply (Local0, 0x02, Local0)</div><div class="line">                If (LNotEqual (Local0, Zero))</div><div class="line">                &#123;</div><div class="line">                    Divide (0x0041CDB4, Local0, Local1, Local0)</div><div class="line">                    Store(Local1, Local1) // Fix Warnings</div><div class="line">                    Return (Local0)</div><div class="line">                &#125;</div><div class="line">                Else</div><div class="line">                &#123;</div><div class="line">                    Return (Ones)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            Else</div><div class="line">            &#123;</div><div class="line">                Return (Ones)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">            // RE1B,RECB,WE1B,WECB Fix 64 128 256 Method</div><div class="line">            Method (RE1B, 1, NotSerialized)</div><div class="line">            &#123;</div><div class="line">                OperationRegion(ERAM, EmbeddedControl, Arg0, 1)</div><div class="line">                Field(ERAM, ByteAcc, NoLock, Preserve) &#123; BYTE, 8 &#125;</div><div class="line">                Return(BYTE)</div><div class="line">            &#125;</div><div class="line">            Method (RECB, 2, Serialized)</div><div class="line">            &#123;</div><div class="line">                ShiftRight(Arg1, 3, Arg1)</div><div class="line">                Name(TEMP, Buffer(Arg1) &#123; &#125;)</div><div class="line">                Add(Arg0, Arg1, Arg1)</div><div class="line">                Store(0, Local0)</div><div class="line">                While (LLess(Arg0, Arg1))</div><div class="line">                &#123;</div><div class="line">                    Store(RE1B(Arg0), Index(TEMP, Local0))</div><div class="line">                    Increment(Arg0)</div><div class="line">                    Increment(Local0)</div><div class="line">                &#125;</div><div class="line">                Return(TEMP)</div><div class="line">            &#125;</div><div class="line">            Method (WE1B, 2, NotSerialized)</div><div class="line">            &#123;</div><div class="line">                OperationRegion(ERAM, EmbeddedControl, Arg0, 1)</div><div class="line">                Field(ERAM, ByteAcc, NoLock, Preserve) &#123; BYTE, 8 &#125;</div><div class="line">                Store(Arg1, BYTE)</div><div class="line">            &#125;</div><div class="line">            Method (WECB, 3, Serialized)</div><div class="line">            &#123;</div><div class="line">                ShiftRight(Arg1, 3, Arg1)</div><div class="line">                Name(TEMP, Buffer(Arg1) &#123; &#125;)</div><div class="line">                Store(Arg2, TEMP)</div><div class="line">                Add(Arg0, Arg1, Arg1)</div><div class="line">                Store(0, Local0)</div><div class="line">                While (LLess(Arg0, Arg1))</div><div class="line">                &#123;</div><div class="line">                    WE1B(Arg0, DerefOf(Index(TEMP, Local0)))</div><div class="line">                    Increment(Arg0)</div><div class="line">                    Increment(Local0)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        Method (BIFA, 0, NotSerialized)</div><div class="line">        &#123;</div><div class="line">            If (ECAV ())</div><div class="line">            &#123;</div><div class="line">                If (BSLF)</div><div class="line">                &#123;</div><div class="line">                    Store (B1B2(B1S0,B1S1), Local0)</div><div class="line">                &#125;</div><div class="line">                Else</div><div class="line">                &#123;</div><div class="line">                    Store (B1B2(B0S0,B0S1), Local0)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            Else</div><div class="line">            &#123;</div><div class="line">                Store (Ones, Local0)</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Return (Local0)</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        Method (SMBR, 3, Serialized)</div><div class="line">        &#123;</div><div class="line">            Store (Package (0x03)</div><div class="line">                &#123;</div><div class="line">                    0x07, </div><div class="line">                    Zero, </div><div class="line">                    Zero</div><div class="line">                &#125;, Local0)</div><div class="line">            If (LNot (ECAV ()))</div><div class="line">            &#123;</div><div class="line">                Return (Local0)</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            If (LNotEqual (Arg0, RDBL))</div><div class="line">            &#123;</div><div class="line">                If (LNotEqual (Arg0, RDWD))</div><div class="line">                &#123;</div><div class="line">                    If (LNotEqual (Arg0, RDBT))</div><div class="line">                    &#123;</div><div class="line">                        If (LNotEqual (Arg0, RCBT))</div><div class="line">                        &#123;</div><div class="line">                            If (LNotEqual (Arg0, RDQK))</div><div class="line">                            &#123;</div><div class="line">                                Return (Local0)</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Acquire (MUEC, 0xFFFF)</div><div class="line">            Store (PRTC, Local1)</div><div class="line">            Store (Zero, Local2)</div><div class="line">            While (LNotEqual (Local1, Zero))</div><div class="line">            &#123;</div><div class="line">                Stall (0x0A)</div><div class="line">                Increment (Local2)</div><div class="line">                If (LGreater (Local2, 0x03E8))</div><div class="line">                &#123;</div><div class="line">                    Store (SBBY, Index (Local0, Zero))</div><div class="line">                    Store (Zero, Local1)</div><div class="line">                &#125;</div><div class="line">                Else</div><div class="line">                &#123;</div><div class="line">                    Store (PRTC, Local1)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            If (LLessEqual (Local2, 0x03E8))</div><div class="line">            &#123;</div><div class="line">                ShiftLeft (Arg1, One, Local3)</div><div class="line">                Or (Local3, One, Local3)</div><div class="line">                Store (Local3, ADDR)</div><div class="line">                If (LNotEqual (Arg0, RDQK))</div><div class="line">                &#123;</div><div class="line">                    If (LNotEqual (Arg0, RCBT))</div><div class="line">                    &#123;</div><div class="line">                        Store (Arg2, CMDB)</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                WECB(0x1c,256,Zero)</div><div class="line">                Store (Arg0, PRTC)</div><div class="line">                Store (SWTC (Arg0), Index (Local0, Zero))</div><div class="line">                If (LEqual (DerefOf (Index (Local0, Zero)), Zero))</div><div class="line">                &#123;</div><div class="line">                    If (LEqual (Arg0, RDBL))</div><div class="line">                    &#123;</div><div class="line">                        Store (BCNT, Index (Local0, One))</div><div class="line">                        Store (RECB(0x1c,256), Index (Local0, 0x02))</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    If (LEqual (Arg0, RDWD))</div><div class="line">                    &#123;</div><div class="line">                        Store (0x02, Index (Local0, One))</div><div class="line">                        Store (B1B2(DT01,DT02), Index (Local0, 0x02))</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    If (LEqual (Arg0, RDBT))</div><div class="line">                    &#123;</div><div class="line">                        Store (One, Index (Local0, One))</div><div class="line">                        Store (DAT0, Index (Local0, 0x02))</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    If (LEqual (Arg0, RCBT))</div><div class="line">                    &#123;</div><div class="line">                        Store (One, Index (Local0, One))</div><div class="line">                        Store (DAT0, Index (Local0, 0x02))</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Release (MUEC)</div><div class="line">            Return (Local0)</div><div class="line">        &#125;</div><div class="line">        Method (ECSB, 7, NotSerialized)</div><div class="line">        &#123;</div><div class="line">            Store (Package (0x05)</div><div class="line">                &#123;</div><div class="line">                    0x11, </div><div class="line">                    Zero, </div><div class="line">                    Zero, </div><div class="line">                    Zero, </div><div class="line">                    Buffer (0x20) &#123;&#125;</div><div class="line">                &#125;, Local1)</div><div class="line">            If (LGreater (Arg0, One))</div><div class="line">            &#123;</div><div class="line">                Return (Local1)</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            If (ECAV ())</div><div class="line">            &#123;</div><div class="line">                Acquire (MUEC, 0xFFFF)</div><div class="line">                If (LEqual (Arg0, Zero))</div><div class="line">                &#123;</div><div class="line">                    Store (PRTC, Local0)</div><div class="line">                &#125;</div><div class="line">                Else</div><div class="line">                &#123;</div><div class="line">                    Store (PRT2, Local0)</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                Store (Zero, Local2)</div><div class="line">                While (LNotEqual (Local0, Zero))</div><div class="line">                &#123;</div><div class="line">                    Stall (0x0A)</div><div class="line">                    Increment (Local2)</div><div class="line">                    If (LGreater (Local2, 0x03E8))</div><div class="line">                    &#123;</div><div class="line">                        Store (SBBY, Index (Local1, Zero))</div><div class="line">                        Store (Zero, Local0)</div><div class="line">                    &#125;</div><div class="line">                    ElseIf (LEqual (Arg0, Zero))</div><div class="line">                    &#123;</div><div class="line">                        Store (PRTC, Local0)</div><div class="line">                    &#125;</div><div class="line">                    Else</div><div class="line">                    &#123;</div><div class="line">                        Store (PRT2, Local0)</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                If (LLessEqual (Local2, 0x03E8))</div><div class="line">                &#123;</div><div class="line">                    If (LEqual (Arg0, Zero))</div><div class="line">                    &#123;</div><div class="line">                        Store (Arg2, ADDR)</div><div class="line">                        Store (Arg3, CMDB)</div><div class="line">                        If (LOr (LEqual (Arg1, 0x0A), LEqual (Arg1, 0x0B)))</div><div class="line">                        &#123;</div><div class="line">                            Store (DerefOf (Index (Arg6, Zero)), BCNT)</div><div class="line">                            WECB(0x1c,256,DerefOf (Index (Arg6, One)))</div><div class="line">                        &#125;</div><div class="line">                        Else</div><div class="line">                        &#123;</div><div class="line">                            Store (Arg4, DAT0)</div><div class="line">                            Store (Arg5, DAT1)</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        Store (Arg1, PRTC)</div><div class="line">                    &#125;</div><div class="line">                    Else</div><div class="line">                    &#123;</div><div class="line">                        Store (Arg2, ADD2)</div><div class="line">                        Store (Arg3, CMD2)</div><div class="line">                        If (LOr (LEqual (Arg1, 0x0A), LEqual (Arg1, 0x0B)))</div><div class="line">                        &#123;</div><div class="line">                            Store (DerefOf (Index (Arg6, Zero)), BCN2)</div><div class="line">                            WECB(0x44,256,DerefOf (Index (Arg6, One)))</div><div class="line">                        &#125;</div><div class="line">                        Else</div><div class="line">                        &#123;</div><div class="line">                            Store (Arg4, DA20)</div><div class="line">                            Store (Arg5, DA21)</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        Store (Arg1, PRT2)</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    Store (0x7F, Local0)</div><div class="line">                    If (LEqual (Arg0, Zero))</div><div class="line">                    &#123;</div><div class="line">                        While (PRTC)</div><div class="line">                        &#123;</div><div class="line">                            Sleep (One)</div><div class="line">                            Decrement (Local0)</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    Else</div><div class="line">                    &#123;</div><div class="line">                        While (PRT2)</div><div class="line">                        &#123;</div><div class="line">                            Sleep (One)</div><div class="line">                            Decrement (Local0)</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    If (Local0)</div><div class="line">                    &#123;</div><div class="line">                        If (LEqual (Arg0, Zero))</div><div class="line">                        &#123;</div><div class="line">                            Store (SSTS, Local0)</div><div class="line">                            Store (DAT0, Index (Local1, One))</div><div class="line">                            Store (DAT1, Index (Local1, 0x02))</div><div class="line">                            Store (BCNT, Index (Local1, 0x03))</div><div class="line">                            Store (RECB(0x1c,256), Index (Local1, 0x04))</div><div class="line">                        &#125;</div><div class="line">                        Else</div><div class="line">                        &#123;</div><div class="line">                            Store (SST2, Local0)</div><div class="line">                            Store (DA20, Index (Local1, One))</div><div class="line">                            Store (DA21, Index (Local1, 0x02))</div><div class="line">                            Store (BCN2, Index (Local1, 0x03))</div><div class="line">                            Store (RECB(0x44,256), Index (Local1, 0x04))</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        And (Local0, 0x1F, Local0)</div><div class="line">                        If (Local0)</div><div class="line">                        &#123;</div><div class="line">                            Add (Local0, 0x10, Local0)</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        Store (Local0, Index (Local1, Zero))</div><div class="line">                    &#125;</div><div class="line">                    Else</div><div class="line">                    &#123;</div><div class="line">                        Store (0x10, Index (Local1, Zero))</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                Release (MUEC)</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Return (Local1)</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        Method (SMBW, 5, Serialized)</div><div class="line">        &#123;</div><div class="line">            Store (Package (0x01)</div><div class="line">                &#123;</div><div class="line">                    0x07</div><div class="line">                &#125;, Local0)</div><div class="line">            If (LNot (ECAV ()))</div><div class="line">            &#123;</div><div class="line">                Return (Local0)</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            If (LNotEqual (Arg0, WRBL))</div><div class="line">            &#123;</div><div class="line">                If (LNotEqual (Arg0, WRWD))</div><div class="line">                &#123;</div><div class="line">                    If (LNotEqual (Arg0, WRBT))</div><div class="line">                    &#123;</div><div class="line">                        If (LNotEqual (Arg0, SDBT))</div><div class="line">                        &#123;</div><div class="line">                            If (LNotEqual (Arg0, WRQK))</div><div class="line">                            &#123;</div><div class="line">                                Return (Local0)</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Acquire (MUEC, 0xFFFF)</div><div class="line">            Store (PRTC, Local1)</div><div class="line">            Store (Zero, Local2)</div><div class="line">            While (LNotEqual (Local1, Zero))</div><div class="line">            &#123;</div><div class="line">                Stall (0x0A)</div><div class="line">                Increment (Local2)</div><div class="line">                If (LGreater (Local2, 0x03E8))</div><div class="line">                &#123;</div><div class="line">                    Store (SBBY, Index (Local0, Zero))</div><div class="line">                    Store (Zero, Local1)</div><div class="line">                &#125;</div><div class="line">                Else</div><div class="line">                &#123;</div><div class="line">                    Store (PRTC, Local1)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            If (LLessEqual (Local2, 0x03E8))</div><div class="line">            &#123;</div><div class="line">                WECB(0x1c,256,Zero)</div><div class="line">                ShiftLeft (Arg1, One, Local3)</div><div class="line">                Store (Local3, ADDR)</div><div class="line">                If (LNotEqual (Arg0, WRQK))</div><div class="line">                &#123;</div><div class="line">                    If (LNotEqual (Arg0, SDBT))</div><div class="line">                    &#123;</div><div class="line">                        Store (Arg2, CMDB)</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                If (LEqual (Arg0, WRBL))</div><div class="line">                &#123;</div><div class="line">                    Store (Arg3, BCNT)</div><div class="line">                    WECB(0x1c,256,Arg4)</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                If (LEqual (Arg0, WRWD))</div><div class="line">                &#123;</div><div class="line">                    Store (ShiftRight(Arg4,8),DT02)</div><div class="line">                    Store (Arg4,DT01)</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                If (LEqual (Arg0, WRBT))</div><div class="line">                &#123;</div><div class="line">                    Store (Arg4, DAT0)</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                If (LEqual (Arg0, SDBT))</div><div class="line">                &#123;</div><div class="line">                    Store (Arg4, DAT0)</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                Store (Arg0, PRTC)</div><div class="line">                Store (SWTC (Arg0), Index (Local0, Zero))</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Release (MUEC)</div><div class="line">            Return (Local0)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    Scope(\_SB.PCI0.BAT0)</div><div class="line">    &#123;</div><div class="line">            Method (_BIX, 0, NotSerialized)  // _BIX: Battery Information Extended</div><div class="line">            &#123;</div><div class="line">                If (LNot (\_SB.PCI0.LPCB.EC0.BATP (Zero)))</div><div class="line">                &#123;</div><div class="line">                    Return (NBIX)</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                If (LEqual (\_SB.PCI0.LPCB.EC0.GBTT (Zero), 0xFF))</div><div class="line">                &#123;</div><div class="line">                    Return (NBIX)</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                _BIF ()</div><div class="line">                Store (DerefOf (Index (PBIF, Zero)), Index (BIXT, One))</div><div class="line">                Store (DerefOf (Index (PBIF, One)), Index (BIXT, 0x02))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x02)), Index (BIXT, 0x03))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x03)), Index (BIXT, 0x04))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x04)), Index (BIXT, 0x05))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x05)), Index (BIXT, 0x06))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x06)), Index (BIXT, 0x07))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x07)), Index (BIXT, 0x0E))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x08)), Index (BIXT, 0x0F))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x09)), Index (BIXT, 0x10))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x0A)), Index (BIXT, 0x11))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x0B)), Index (BIXT, 0x12))</div><div class="line">                Store (DerefOf (Index (PBIF, 0x0C)), Index (BIXT, 0x13))</div><div class="line">                If (LEqual (DerefOf (Index (BIXT, One)), One))</div><div class="line">                &#123;</div><div class="line">                    Store (Zero, Index (BIXT, One))</div><div class="line">                    Store (DerefOf (Index (BIXT, 0x05)), Local0)</div><div class="line">                    Multiply (DerefOf (Index (BIXT, 0x02)), Local0, Index (BIXT, 0x02))</div><div class="line">                    Multiply (DerefOf (Index (BIXT, 0x03)), Local0, Index (BIXT, 0x03))</div><div class="line">                    Multiply (DerefOf (Index (BIXT, 0x06)), Local0, Index (BIXT, 0x06))</div><div class="line">                    Multiply (DerefOf (Index (BIXT, 0x07)), Local0, Index (BIXT, 0x07))</div><div class="line">                    Multiply (DerefOf (Index (BIXT, 0x0E)), Local0, Index (BIXT, 0x0E))</div><div class="line">                    Multiply (DerefOf (Index (BIXT, 0x0F)), Local0, Index (BIXT, 0x0F))</div><div class="line">                    Divide (DerefOf (Index (BIXT, 0x02)), 0x03E8, Local0, Index (BIXT, 0x02))</div><div class="line">                    Divide (DerefOf (Index (BIXT, 0x03)), 0x03E8, Local0, Index (BIXT, 0x03))</div><div class="line">                    Divide (DerefOf (Index (BIXT, 0x06)), 0x03E8, Local0, Index (BIXT, 0x06))</div><div class="line">                    Divide (DerefOf (Index (BIXT, 0x07)), 0x03E8, Local0, Index (BIXT, 0x07))</div><div class="line">                    Divide (DerefOf (Index (BIXT, 0x0E)), 0x03E8, Local0, Index (BIXT, 0x0E))</div><div class="line">                    Divide (DerefOf (Index (BIXT, 0x0F)), 0x03E8, Local0, Index (BIXT, 0x0F))</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                Store (B1B2(^^LPCB.EC0.B001,^^LPCB.EC0.B002), Index (BIXT, 0x08))</div><div class="line">                Store (0x0001869F, Index (BIXT, 0x09))</div><div class="line">                Return (BIXT)</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">        Method (B1B2, 2, NotSerialized)</div><div class="line">        &#123;</div><div class="line">            ShiftLeft (Arg1, 8, Local0)</div><div class="line">            Or (Arg0, Local0, Local0)</div><div class="line">            Return (Local0)</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>好了,以上 SSDT 编译已经通过,那么我们进行最后一步,将上述复制过来的 Method 一一的重命名,使得原有的 Method 失效,这样我们注入的 SSDT 的新 Method 才能生效.</p>
<p>我们需要重命名的 Method 有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- Method (TACH, 1, Serialized)</div><div class="line">- Method (_BIX, 0, NotSerialized)</div><div class="line">- Method (BIFA, 0, NotSerialized)</div><div class="line">- Method (SMBR, 3, Serialized)</div><div class="line">- Method (ECSB, 7, NotSerialized)</div><div class="line">- Method (SMBW, 5, Serialized)</div></pre></td></tr></table></figure>
<p>在 config.plist 中编写补丁 ACPI &gt; DSDT &gt; Patches</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"># TACH</div><div class="line">Comment: change Method(TACH,1,N) to XACH, optionally pair with SSDT-BATT-VM510LI.aml</div><div class="line">Find:14 40 06 54 41 43 48 09</div><div class="line">Replace:14 40 06 58 41 43 48 09</div><div class="line"></div><div class="line"># _BIX</div><div class="line">Comment: change Method(_BIX,0,N) to XBIX, optionally pair with SSDT-BATT-VM510LI.aml</div><div class="line">Find:14 49 26 5F 42 49 58 00</div><div class="line">Replace:14 49 26 58 42 49 58 00</div><div class="line"></div><div class="line"># BIFA</div><div class="line">Comment: change Method(BIFA,0,N) to XIFA, optionally pair with SSDT-BATT-VM510LI.aml</div><div class="line">Find:14 27 42 49 46 41 00</div><div class="line">Replace:14 27 58 49 46 41 00</div><div class="line"></div><div class="line"># SMBR</div><div class="line">Comment: change Method(SMBR,3,N) to XMBR, optionally pair with SSDT-BATT-VM510LI.aml</div><div class="line">Find:14 4B 13 53 4D 42 52 0B</div><div class="line">Replace:14 4B 13 58 4D 42 52 0B</div><div class="line"></div><div class="line"># ECSB</div><div class="line">Comment: change Method(ECSB,7,N) to XCSB, optionally pair with SSDT-BATT-VM510LI.aml</div><div class="line">Find:14 4F 1A 45 43 53 42 07 </div><div class="line">Replace:14 4F 1A 58 43 53 42 07 </div><div class="line"></div><div class="line"># SMBW</div><div class="line">Comment: change Method(SMBW,5,N) to XMBW, optionally pair with SSDT-BATT-VM510LI.aml</div><div class="line">Find:14 45 10 53 4D 42 57 0D</div><div class="line">Replace:14 45 10 58 4D 42 57 0D</div></pre></td></tr></table></figure>
<p><strong>提示,不放心自己找的代码,可以拿个从 Ubuntu 提取未修改过的 DSDT.aml, 用 Hex Fiend 来替换下,再反编译看看,反编译后无需修改,直接搜索我们修改的变量名,看是否已经改成 X 开头.</strong></p>
<h2 id="注入显卡-ID"><a href="#注入显卡-ID" class="headerlink" title="注入显卡 ID"></a>注入显卡 ID</h2><ol>
<li>将 GFX 更名为 IGPU</li>
<li>放入 SSDT-IGPU.aml 至 Clover &gt; ACPI &gt; patched</li>
</ol>
<h2 id="屏蔽独立显卡"><a href="#屏蔽独立显卡" class="headerlink" title="屏蔽独立显卡"></a>屏蔽独立显卡</h2><p>首先复习一下屏蔽独立显卡的方法:</p>
<blockquote>
<p>引用自:<a href="https://www.firewolf.science/2015/05/%E5%B1%8F%E8%94%BD%E5%8F%8C%E6%98%BE%E5%8D%A1%E7%AC%94%E8%AE%B0%E6%9C%AC%E7%9A%84%E7%8B%AC%E6%98%BE/" target="_blank" rel="external">屏蔽双显卡笔记本的独显</a></p>
<p>我们的目标非常简单。通常，在SSDT里，笔记本给我们提供了一个 _OFF 方法，我们可以通过调用这个方法，来切段独显的供电。最最简单的方法，就是在 相应的_INI方法里，调用_OFF方法。需要注意，这个_OFF方法，还可能会在DSDT里，或者可能会有不同的名字（如：GPOF、OPOF、_PS3，等等）。</p>
<p>某些_OFF方法的实现，会由于它包含了对EC(Embedded Controller)的依赖，而使得它不能在_INI方法里被调用。对于这样的情况，整个_OFF方法或者它的一部分代码，需要被移动到_REG方法里，以延迟执行（当_REG方法接收的参数Arg0 == 3 且 Arg1==1时，它会在_INI方法之后被执行）（详见ACPI规范）。对于一些情况，在_REG方法里调用_OFF的时机太迟了，从而导致要么屏蔽独显失败，要么系统五国。对于这样的情况，修改_OFF方法，移除它对于EC的依赖，将变得必要。之后，我们就可以在_INI里调用它（移除了对EC的依赖的_OFF）。同时，在_OFF里移除的代码，需要加到_REG里去。这样，虽然EC关联的代码在后（_INI后）执行（因为代码加到了_REG里，所以后执行），但却能达到更好的效果。贴子提供的例子，就是这种情况。</p>
</blockquote>
<p>我是根据上面的方法来屏蔽我华硕 VM510LI 的 AMD 显卡的,很不幸的是,我的 _OFF 也包含了对 EC 的依赖,故此我在 hotpatch 当中,我并不能单纯的使用 SSDT-Disable_DGPU.aml 来禁用独立显卡.</p>
<p>那么该如何使用 hotpatch 方法来屏蔽我们的独立显卡呢?</p>
<p>于是我扒到了这个帖子:<a href="https://www.tonymacx86.com/threads/guide-disabling-discrete-graphics-in-dual-gpu-laptops.163772/page-55#post-1232166" target="_blank" rel="external">https://www.tonymacx86.com/threads/guide-disabling-discrete-graphics-in-dual-gpu-laptops.163772/page-55#post-1232166</a></p>
<p>帖子提供了一个例子.<a href="https://raw.githubusercontent.com/RehabMan/Lenovo-Z50/master/hotpatch/SSDT-NVDA.dsl" target="_blank" rel="external">https://raw.githubusercontent.com/RehabMan/Lenovo-Z50/master/hotpatch/SSDT-NVDA.dsl</a></p>
<p>仔细查看例子中的代码会发现和上述屏蔽独立显卡不同的地方.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">External(_SB.PCI0, DeviceObj)</div><div class="line">Scope(_SB.PCI0)</div><div class="line">&#123;</div><div class="line">    Device(RMD2)</div><div class="line">    &#123;</div><div class="line">        Name(_HID, &quot;RMD20000&quot;)</div><div class="line">        Method(_INI)</div><div class="line">        &#123;</div><div class="line">           If (CondRefOf(\_SB.PCI0.RP05.PEGP._OFF)) &#123; \_SB.PCI0.RP05.PEGP._OFF() &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>看上述的代码段,他会重新定义一个设备,这个设备叫 RMD20000,然后这个设备有一个 INI 方法,里面就是调用 _OFF, 关闭显卡的系统方法.</p>
<p>那么,其实关闭显卡并不一定要在显卡启动的 INI 方法中运行 OFF 切断显卡电源,我估计是 PCI0 的设备是统一时间初始化的,其他设备的 INI 也一样可以将显卡电源关闭.</p>
<p>而我 _OFF 方法中存在一个 SGOF 的方法,这个方法里面调用了 EC0 的代码,那么需要将他去掉,故此我需要用重命名代替的方法,将原来的 SGOF 方法用重命名方法禁用掉,然后再用 SSDT 注入我们修改的 SGOF 方法, 由于 SGOF 方法中的 EC 相关的代码需要在 _REG 中执行,故此我们也需要将原有的 _REG 方法重命名禁用掉,也在 SSDT 中写入我们的 _REG 方法.</p>
<p>依然老方法,我不会写 SSDT, 但是我会抄.用上述的 SSDT-NVDA.dsl 来改成我们自己的 禁用显卡 SSDT.</p>
<p>最终写出来的 SSDT 应该就是这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line">// SSDT-DAMD: Disable AMD</div><div class="line">DefinitionBlock (&quot;&quot;, &quot;SSDT&quot;, 2, &quot;hack&quot;, &quot;DAMD&quot;, 0)</div><div class="line">&#123;</div><div class="line">    External(_SB.PCI0, DeviceObj)</div><div class="line">    External(\_SB.PCI0.RP05.PEGP._OFF,MethodObj)</div><div class="line">    External (HLRS, FieldUnitObj)</div><div class="line">    External (PWEN, FieldUnitObj)</div><div class="line">    Scope(_SB.PCI0)</div><div class="line">    &#123;</div><div class="line">        Device(RMD2)</div><div class="line">        &#123;</div><div class="line">            Name(_HID, &quot;RMD20000&quot;)</div><div class="line">            Method(_INI)</div><div class="line">            &#123;</div><div class="line">               If (CondRefOf(\_SB.PCI0.RP05.PEGP._OFF)) &#123; \_SB.PCI0.RP05.PEGP._OFF() &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        External(RP05, DeviceObj)</div><div class="line">        Scope(RP05)</div><div class="line">        &#123;</div><div class="line">            External(PEGP, DeviceObj)</div><div class="line">            Scope(PEGP)</div><div class="line">            &#123;</div><div class="line">                External(CCHK, MethodObj)</div><div class="line">                External(ONOF, IntObj)</div><div class="line">                External(LCTL,IntObj)</div><div class="line">                External(ELCT, IntObj)</div><div class="line">                External(SVID, IntObj)</div><div class="line">                External(HVID, IntObj)</div><div class="line">                External(SDID, IntObj)</div><div class="line">                External(HDID, IntObj)</div><div class="line">                External(LNKD, IntObj)</div><div class="line">                External(LNKD, IntObj)</div><div class="line">                External(LNKS, IntObj)</div><div class="line">                External(SGPO, MethodObj)</div><div class="line">                Method (SGOF, 0, Serialized)</div><div class="line">                &#123;</div><div class="line">                    If (LEqual (CCHK (Zero), Zero))</div><div class="line">                    &#123;</div><div class="line">                        Return (Zero)</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    Store (Zero, ONOF)</div><div class="line">                    //Store (\_SB.PCI0.LPCB.EC0.RRAM (0x0521), Local0)</div><div class="line">                    //And (Local0, 0xCF, Local0)</div><div class="line">                    //\_SB.PCI0.LPCB.EC0.WRAM (0x0521, Local0)</div><div class="line">                    //\_SB.PCI0.LPCB.EC0.WRAM (0x0520, 0x91)</div><div class="line">                    //\_SB.PCI0.LPCB.EC0.WRAM (0x03A4, Zero)</div><div class="line">                    //\_SB.PCI0.LPCB.EC0.WRAM (0x03A5, Zero)</div><div class="line">                    Store (LCTL, ELCT)</div><div class="line">                    Store (SVID, HVID)</div><div class="line">                    Store (SDID, HDID)</div><div class="line">                    Store (One, LNKD)</div><div class="line">                    While (LNotEqual (LNKS, Zero))</div><div class="line">                    &#123;</div><div class="line">                        Sleep (One)</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    SGPO (HLRS, One)</div><div class="line">                    SGPO (PWEN, Zero)</div><div class="line">                    Return (Zero)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        External(LPCB, DeviceObj)</div><div class="line">        Scope(LPCB)</div><div class="line">        &#123;</div><div class="line">            External(EC0, DeviceObj)</div><div class="line">            Scope(EC0)</div><div class="line">            &#123;</div><div class="line">                External(ECFL, IntObj)</div><div class="line">                External(RRAM, MethodObj)</div><div class="line">                External(WRAM, MethodObj)</div><div class="line">                Method (_REG, 2, NotSerialized)  // _REG: Region Availability</div><div class="line">                &#123;</div><div class="line">                    If (LEqual (Arg0, 0x03))</div><div class="line">                    &#123;</div><div class="line">                        Store (Arg1, ECFL)</div><div class="line">                    &#125;</div><div class="line">                    </div><div class="line">                    If (LAnd(LEqual(Arg0,3),LEqual(Arg1,1)))</div><div class="line">                    &#123;</div><div class="line">                        Store (\_SB.PCI0.LPCB.EC0.RRAM (0x0521), Local0)</div><div class="line">                        And (Local0, 0xCF, Local0)</div><div class="line">                        \_SB.PCI0.LPCB.EC0.WRAM (0x0521, Local0)</div><div class="line">                        \_SB.PCI0.LPCB.EC0.WRAM (0x0520, 0x91)</div><div class="line">                        \_SB.PCI0.LPCB.EC0.WRAM (0x03A4, Zero)</div><div class="line">                        \_SB.PCI0.LPCB.EC0.WRAM (0x03A5, Zero)</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后我们需要重命名的就是两个方法,一个 SGOF, 和 _REG.</p>
<p>在 Clover &gt; ACPI &gt; DSDT &gt; Patches 添加如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># SGOF</div><div class="line">Comment:change Method(SGOF,0,Serialized) to XGOF, optionally pair with SSDT-DAMD-VM510LI.aml</div><div class="line">Find:53474F46 08</div><div class="line">Replace:58474F46 08</div><div class="line"></div><div class="line"># _REG</div><div class="line">Comment:change Method(_REG,0,Serialized) to XREG, optionally pair with SSDT-DAMD-VM510LI.aml</div><div class="line">Find:5F 52 45 47 02</div><div class="line">Replace:58 52 45 47 02</div></pre></td></tr></table></figure>
<h2 id="注入声卡-ID"><a href="#注入声卡-ID" class="headerlink" title="注入声卡 ID"></a>注入声卡 ID</h2><p>这个非常简单,只需要放入 SSDT-HDEF.aml 到 Clover &gt; ACPI &gt; patched</p>
<p>但是需要注意自己的 DSDT 有没有定义 HDEF 设备,如果没有,打开 SSDT-HDEF.dsl 将以下注释去掉.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">// Note: If your ACPI set (DSDT+SSDTs) does not define HDEF (or AZAL)</div><div class="line">// add this Device definition (by uncommenting it)</div><div class="line">//</div><div class="line">//Device(_SB.PCI0.HDEF)</div><div class="line">//&#123;</div><div class="line">//    Name(_ADR, 0x001b0000)</div><div class="line">//    Name(_PRW, Package() &#123; 0x0d, 0x05 &#125;) // may need tweaking (or not needed)</div><div class="line">//&#125;</div></pre></td></tr></table></figure>
<p><del>另外注意修改自己需要注入的 ID, 我的是4</del></p>
<p>无需修改 ID,我们只需在 SSDT-Config.aml 的 Name(AUDL, Ones)  定义我们注入的 ID 即可。（关于SSDT-Config.aml 更多的参数细节，后续会提到。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">    Method(_SB.PCI0.HDEF._DSM, 4)</div><div class="line">    &#123;</div><div class="line">        If (CondRefOf(\RMCF.AUDL)) &#123; If (Ones == \RMCF.AUDL) &#123; Return(0) &#125; &#125;</div><div class="line">        If (!Arg2) &#123; Return (Buffer() &#123; 0x03 &#125; ) &#125;</div><div class="line">        Local0 = Package()</div><div class="line">        &#123;</div><div class="line">            &quot;layout-id&quot;, Buffer(4) &#123; 4, 0, 0, 0 &#125;, </div><div class="line">            &quot;hda-gfx&quot;, Buffer() &#123; &quot;onboard-1&quot; &#125;,</div><div class="line">            &quot;PinConfigurations&quot;, Buffer() &#123; &#125;,</div><div class="line">        &#125;</div><div class="line">        If (CondRefOf(\RMCF.AUDL))</div><div class="line">        &#123;</div><div class="line">            CreateDWordField(DerefOf(Local0[1]), 0, AUDL)</div><div class="line">            AUDL = \RMCF.AUDL</div><div class="line">        &#125;</div><div class="line">        Return(Local0)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><del>但是不清楚为什么上面的注入不正常,我用回 Clover 的 Devices 里面的 Inject 设置为4 RestHDA 设为 yes</del></p>
<p>终于知道为何放入上面 SSDT 后声卡依然无声，是因为 SSDT-config.dsl 问题。在下面的章节补上对这个非常非常重要的 SSDT-Config.aml 的讲解</p>
<p>上面的 HDEF 只是给声卡出声而已，还需要放入 SSDT-HDAU.aml 以给 HDMI 出声。</p>
<p>最终 HDMI 声音和声卡声音都能正常出声。</p>
<h2 id="SSDT-Config-说明"><a href="#SSDT-Config-说明" class="headerlink" title="SSDT-Config 说明"></a>SSDT-Config 说明</h2><p>这个漏了说，而且这个是 Hotpatch 必用的 SSDT，因为里面包含了一些配置。</p>
<p>首先我们来看看 SSDT-Config 有些啥？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line">// configuration data for other SSDTs in this pack</div><div class="line"></div><div class="line">DefinitionBlock(&quot;&quot;, &quot;SSDT&quot;, 2, &quot;hack&quot;, &quot;RMCF&quot;, 0)</div><div class="line">&#123;</div><div class="line">    Device(RMCF)</div><div class="line">    &#123;</div><div class="line">        Name(_ADR, 0)   // do not remove</div><div class="line"></div><div class="line">        Method(HELP)</div><div class="line">        &#123;</div><div class="line">            Store(&quot;TYPE indicates type of the computer. 0: desktop, 1: laptop&quot;, Debug)</div><div class="line">            Store(&quot;HIGH selects display type. 1: high resolution, 2: low resolution&quot;, Debug)</div><div class="line">            Store(&quot;DPTS for laptops only. 1: enables/disables DGPU in _WAK/_PTS&quot;, Debug)</div><div class="line">            Store(&quot;SHUT enables shutdown fix. 1: disables _PTS code when Arg0==5&quot;, Debug)</div><div class="line">            Store(&quot;AUDL indicates audio layout-id for patched AppleHDA. Ones: no injection&quot;, Debug)</div><div class="line">            Store(&quot;BKLT indicates the type of backlight control. 0: IntelBacklight, 1: AppleBacklight&quot;, Debug)</div><div class="line">            Store(&quot;LMAX indicates max for IGPU PWM backlight. Ones: Use default, other values must match framebuffer&quot;, Debug)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // TYPE: Indicates the type of computer... desktop or laptop</div><div class="line">        //</div><div class="line">        //  0: desktop</div><div class="line">        //  0: 台式机</div><div class="line">        //  1: laptop</div><div class="line">        //  1: 笔记本</div><div class="line">        Name(TYPE, 1)</div><div class="line"></div><div class="line">        // HIGH: High resolution/low resolution selection.  Affects IGPU injection.</div><div class="line">        // HIGH: 高分辨率/低分辨率选择。 影响IGPU注入。</div><div class="line">        // For 1600x900+ on Sandy/Ivy, use 1</div><div class="line">        // 对于1600x900 +在Sandy / Ivy，请使用1</div><div class="line">        // For UHD/QHD+ on Haswell/Broadwell, use 1</div><div class="line">        // 对于Haswell / Broadwell的UHD / QHD +，请使用1</div><div class="line">        // Others (low resolution), use 0</div><div class="line">        // 其他（低分辨率），使用0</div><div class="line">        Name(HIGH, 0)</div><div class="line"></div><div class="line">        // DPTS: For laptops only: set to 1 if you want to enable and</div><div class="line">        // DPTS：仅适用于笔记本电脑：如果要启用和，请设置为1</div><div class="line">        //  disable the DGPU _PTS and _WAK.</div><div class="line">        //  禁用DGPU _PTS和_WAK。</div><div class="line">        //  0: does not manipulate the DGPU in _WAK and _PTS</div><div class="line">        //  0：不操作_WAK和_PTS中的DGPU</div><div class="line">        //  1: disables the DGPU in _WAK and enables it in _PTS</div><div class="line">        //  1：禁用_WAK中的DGPU，并在_PTS中启用它</div><div class="line">        Name(DPTS, 0)</div><div class="line"></div><div class="line">        // SHUT: Shutdown fix, disable _PTS code when Arg0==5 (shutdown)</div><div class="line">        // SHUT：关闭修复，当Arg0 == 5（关闭）时禁用_PTS代码，</div><div class="line">        //  0: does not affect _PTS behavior during shutdown</div><div class="line">        //  0：在关闭期间不影响_PTS行为</div><div class="line">        //  1: disables _PTS code during shutdown</div><div class="line">        //  1：在关闭期间禁用_PTS代码</div><div class="line">        Name(SHUT, 0)</div><div class="line"></div><div class="line">        // AUDL: Audio Layout</div><div class="line">        // AUDL：音频布局</div><div class="line">        // The value here will be used to inject layout-id for HDEF and HDAU</div><div class="line">        // 这里的值将用于注入HDEF和HDAU的layout-id</div><div class="line">        // If set to Ones, no audio injection will be done.</div><div class="line">        // 如果设置为Ones，则不会进行音频插入。</div><div class="line">        Name(AUDL, Ones)</div><div class="line"></div><div class="line">        // BKLT: Backlight control type</div><div class="line">        // BKLT：背光控制类型</div><div class="line">        // 0: Using IntelBacklight.kext</div><div class="line">        // 0：使用IntelBacklight.kext</div><div class="line">        // 1: Using AppleBacklight.kext + AppleBacklightInjector.kext</div><div class="line">        // 1：使用AppleBacklight.kext + AppleBacklightInjector.kext</div><div class="line">        Name(BKLT, 0)</div><div class="line"></div><div class="line">        // LMAX: Backlight PWM MAX.  Must match framebuffer in use.</div><div class="line">        // LMAX：背光PWM最大值。 必须匹配使用中的帧缓冲区。</div><div class="line">        // Ones: Default will be used (0x710 for Ivy/Sandy, 0xad9 for Haswell/Broadwell)</div><div class="line">        // Ones：将使用默认（Ivy / Sandy 的默认值是 0x710，Haswell / Broadwell 的默认值是 0xad9）</div><div class="line">        // Other values: must match framebuffer</div><div class="line">        // 其他值：必须与framebuffer相匹配</div><div class="line">        Name(LMAX, Ones)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">//EOF</div></pre></td></tr></table></figure>
<p>上面 RM 都注释了，我以 Google 翻译过来，方便理解。</p>
<ul>
<li>第一个值，<strong>TYPE</strong> 从 SSDT-IGPU 调用，影响显卡 ID 的注入。查看了下代码，好像是区分是否注入高分屏 ID 有关。</li>
<li>第二个值，<strong>HIGH</strong> 从 SSDT-IGPU 调用，影响显卡 ID 的注入。当 TYPE 设置成笔记本才生效。</li>
<li>第三个值，<strong>DPTS</strong> 从 SSDT-PTSWAK 调用，这个 SSDT 是重写了睡眠和唤醒的方法，加入了一些我们补丁需要用到的代码，这里设置 1 则会在睡眠的时候开启显卡，唤醒后关闭显卡。</li>
<li>第四个值，<strong>SHUT</strong> 从 SSDT-PTSWAK 调用，这个 SSDT 功能同上，这里设置 1 则会在关机的时候禁用 _PTS，和 Shutdown fix 同理。</li>
<li>第五个值，<strong>AUDL</strong> 从 SSDT-HDAU 和 SSDT-HDEF 调用，这两个 SSDT 前者负责注入声卡 ID，后者则负责注入 HDMI 声卡 ID，而这个值就是控制两个 SSDT 注入声卡的行为，如果写 Ones 则什么都不注入，如果写 3，则声卡的 layout-id 则为 3。</li>
<li>第六个值，<strong>BKLT</strong> 从 SSDT-PNLF 调用，这个 SSDT 看名字大家应该都很熟悉，就是加入 PNLF 设备，用来启用我们的笔记本亮度调节驱动的，而这个值是控制亮度调节的驱动是用哪一种，0 是使用 IntelBacklight.kext，1 是使用 AppleBacklight.kext + AppleBacklightInjector.kext。</li>
<li>第七个值，<strong>LMAX</strong> 从 SSDT-PNLF 调用，这个 SSDT 同上，这个值是设置背光的 PWM 最大值，Ones 是使用默认值，Ivy / Sandy 的默认值是 0x710，Haswell / Broadwell 的默认值是 0xad9，你也可以设置其他值，但是这个值必须与 framebuffer 相匹配。</li>
</ul>
<h2 id="变频-声卡-CC-配置-USB-遮蔽器"><a href="#变频-声卡-CC-配置-USB-遮蔽器" class="headerlink" title="变频\声卡 CC 配置\USB 遮蔽器"></a>变频\声卡 CC 配置\USB 遮蔽器</h2><p>这些在黑苹果各大论坛都有介绍,我就不再论述,只需放入 SSDT 即可.</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>全部修改后,到最重要一步,测试修改的 hotpatch 是否可用.</p>
<p>还挺幸运的,一直写下来的笔记,就 FN 因为完全无脑抄袭没有注意自己的 Q0E 和 Q0F 是在 _SB.PCI0.LPCB.EC0 设备里面,我没把他们放到这个 Scope (域) 里面,故此不生效.</p>
<h2 id="最后附上-VM510LI-Hotpatch-的-EFI"><a href="#最后附上-VM510LI-Hotpatch-的-EFI" class="headerlink" title="最后附上 VM510LI-Hotpatch 的 EFI"></a>最后附上 VM510LI-Hotpatch 的 EFI</h2><p><a href="https://blog.neroxps.cn/blog/macOS/VM510LI-hotpatch.zip" target="_blank" rel="external">VM510LI-Hotpatch.zip</a></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul>
<li><a href="http://luleimi.blog.163.com/blog/static/175219645201011201537841/" target="_blank" rel="external">External()用法</a></li>
<li><a href="http://bbs.pcbeta.com/viewthread-944566-1-1.html" target="_blank" rel="external">自己动手写DSDT系列教程1-ASL（ACPI Source Language）基础篇</a></li>
<li><a href="https://github.com/RehabMan/OS-X-Clover-Laptop-Config/tree/master/hotpatch" target="_blank" rel="external">OS-X-Clover-Laptop-Config</a></li>
<li><a href="https://github.com/RehabMan/HP-ProBook-4x30s-DSDT-Patch/tree/master/hotpatch" target="_blank" rel="external">HP-ProBook-4x30s-DSDT-Patch</a></li>
<li><a href="https://www.tonymacx86.com/threads/guide-using-clover-to-hotpatch-acpi.200137/" target="_blank" rel="external">Guide Using Clover to “hotpatch” ACPI</a></li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/黑苹果/" rel="tag"># 黑苹果</a>
          
            <a href="/tags/Mac/" rel="tag"># Mac</a>
          
            <a href="/tags/Hackintosh/" rel="tag"># Hackintosh</a>
          
            <a href="/tags/ASUS/" rel="tag"># ASUS</a>
          
            <a href="/tags/VM510LI/" rel="tag"># VM510LI</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/01/31/ASUS-VM510LI-Disable-graphics/" rel="next" title="华硕 VM510LI 屏蔽独显">
                <i class="fa fa-chevron-left"></i> 华硕 VM510LI 屏蔽独显
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/02/26/ACPI-Memo/" rel="prev" title="ACPI 一些备忘">
                ACPI 一些备忘 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yOTYyMi82MTkw"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="Nero Hau" />
          <p class="site-author-name" itemprop="name">Nero Hau</p>
           
              <p class="site-description motion-element" itemprop="description">这里就是一堆流水账和技术笔记 | LINUX初学者 | 黑苹果初学者</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">27</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">43</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/NeroNeroxps" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/neroxps" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Hotpatch-简述"><span class="nav-number">1.</span> <span class="nav-text">Hotpatch 简述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Clover-常规补丁"><span class="nav-number">2.</span> <span class="nav-text">Clover 常规补丁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OS-Check-Fix（Windows-7）和-OS-Check-Fix（Windows-8）"><span class="nav-number">3.</span> <span class="nav-text">OS Check Fix（Windows 7）和 OS Check Fix（Windows 8）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rename-GFX0-to-IGPU"><span class="nav-number">4.</span> <span class="nav-text">Rename GFX0 to IGPU</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Brightness-fix-Haswell-Broadwell"><span class="nav-number">5.</span> <span class="nav-text">Brightness fix(Haswell/Broadwell)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#USB3-PRW-0X6D-instant-wake"><span class="nav-number">6.</span> <span class="nav-text">USB3_PRW 0X6D(instant wake)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ApplePS2SmartTouchPad-驱动的-Fn-按键补丁"><span class="nav-number">7.</span> <span class="nav-text">ApplePS2SmartTouchPad 驱动的 Fn 按键补丁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#替换-Q0E-和-Q0F-方法名称"><span class="nav-number">7.1.</span> <span class="nav-text">替换 _Q0E 和 _Q0F 方法名称</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重定义新的-Q0E-和-Q0F-方法"><span class="nav-number">7.2.</span> <span class="nav-text">重定义新的 _Q0E 和 _Q0F 方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#电池补丁"><span class="nav-number">8.</span> <span class="nav-text">电池补丁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#方法分析"><span class="nav-number">8.1.</span> <span class="nav-text">方法分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将-EC-赋值的需要拆分的变量写入到-SSDT-BATT-dsl"><span class="nav-number">8.2.</span> <span class="nav-text">将 EC 赋值的需要拆分的变量写入到 SSDT-BATT.dsl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将调用了以上变量的方法复制到-SSDT-BATT-dsl"><span class="nav-number">8.3.</span> <span class="nav-text">将调用了以上变量的方法复制到 SSDT-BATT.dsl</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注入显卡-ID"><span class="nav-number">9.</span> <span class="nav-text">注入显卡 ID</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#屏蔽独立显卡"><span class="nav-number">10.</span> <span class="nav-text">屏蔽独立显卡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注入声卡-ID"><span class="nav-number">11.</span> <span class="nav-text">注入声卡 ID</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SSDT-Config-说明"><span class="nav-number">12.</span> <span class="nav-text">SSDT-Config 说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#变频-声卡-CC-配置-USB-遮蔽器"><span class="nav-number">13.</span> <span class="nav-text">变频\声卡 CC 配置\USB 遮蔽器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试"><span class="nav-number">14.</span> <span class="nav-text">测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#最后附上-VM510LI-Hotpatch-的-EFI"><span class="nav-number">15.</span> <span class="nav-text">最后附上 VM510LI-Hotpatch 的 EFI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文章"><span class="nav-number">16.</span> <span class="nav-text">参考文章</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Nero Hau</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("KnPfHF2nqcEcD8STh9gned1Q-gzGzoHsz", "OWzEqIfokwLipVPXJ0sPrFBf");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
